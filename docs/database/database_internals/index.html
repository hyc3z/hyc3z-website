<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Hyc3z&#39;s blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Hyc3z&#39;s blog Atom Feed"><title data-react-helmet="true">Database Basics | Hyc3z&#x27;s blog</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://hyc3z.github.io/docs/database/database_internals"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Database Basics | Hyc3z&#x27;s blog"><meta data-react-helmet="true" name="description" content="DBMS分类"><meta data-react-helmet="true" property="og:description" content="DBMS分类"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://hyc3z.github.io/docs/database/database_internals"><link data-react-helmet="true" rel="alternate" href="https://hyc3z.github.io/docs/database/database_internals" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://hyc3z.github.io/docs/database/database_internals" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.98273567.css">
<link rel="preload" href="/assets/js/runtime~main.ad57eab9.js" as="script">
<link rel="preload" href="/assets/js/main.878a9392.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Hyc3z&#x27;s blog</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Notes</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/hyc3z" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Hyc3z<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">🌜</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">🌞</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">intro</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/ai/deep_learning">ai</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/big-data/hadoop">big-data</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/cpp/pcal">cpp</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/cryptography/overview">cryptography</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/blockchain/Chainlink">blockchain</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/data/data_science">data</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/design/microservices">design</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_VCh3" aria-current="page" href="/docs/database/Oracle">database</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/database/Oracle">Oracle</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/database/database_internals">Database Basics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/database/mongodb">MongoDB</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" href="/docs/git/">git</a><button aria-label="Toggle the collapsible sidebar category &#x27;git&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/graph/graph-database">graph</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/python/re">python</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/ts/typescript">ts</a></div></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Database Basics</h1></header><h4 class="anchor anchorWithStickyNavbar_mojV" id="dbms分类">DBMS分类<a class="hash-link" href="#dbms分类" title="Direct link to heading">​</a></h4><h5 class="anchor anchorWithStickyNavbar_mojV" id="oltp-online-transaction-processing">OLTP Online Transaction Processing<a class="hash-link" href="#oltp-online-transaction-processing" title="Direct link to heading">​</a></h5><p>面向用户的请求和事务处理，Query是预先定好的</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="olap-online-analytical-processing">OLAP Online Analytical Processing<a class="hash-link" href="#olap-online-analytical-processing" title="Direct link to heading">​</a></h5><p>复杂聚合任务，分析、存储数据，运行复杂的query</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="htap-hybrid-transactional-and-analytical-processing">HTAP Hybrid transactional and analytical processing<a class="hash-link" href="#htap-hybrid-transactional-and-analytical-processing" title="Direct link to heading">​</a></h5><p>混合了OLAP和OLTP的特性</p><p><img alt="dbin 0101" src="/assets/images/dbin_0101-37a1b1b725536ff01d7d39ea1509cd11.png" width="1182" height="1880"></p><p>Query -&gt; Execution plan -&gt; Execution engine -&gt; Storage engine</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="storage-engine">Storage Engine<a class="hash-link" href="#storage-engine" title="Direct link to heading">​</a></h4><h5 class="anchor anchorWithStickyNavbar_mojV" id="transaction-manager">Transaction Manager<a class="hash-link" href="#transaction-manager" title="Direct link to heading">​</a></h5><p>管理事务，事务只有在确保一致性的情况下才能离开数据库</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="lock-manager">Lock Manager<a class="hash-link" href="#lock-manager" title="Direct link to heading">​</a></h5><p>负责给数据库对象加锁，保证数据完整性</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="access-methodsstorage-structures">Access Methods(storage structures)<a class="hash-link" href="#access-methodsstorage-structures" title="Direct link to heading">​</a></h5><p>数据在磁盘上的存取，B-Tree LSM Tree</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="buffer-manager">Buffer Manager<a class="hash-link" href="#buffer-manager" title="Direct link to heading">​</a></h5><p>在内存中缓存数据</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="recovery-manager">Recovery Manager<a class="hash-link" href="#recovery-manager" title="Direct link to heading">​</a></h5><p>存储操作日志，在出错时恢复系统状态</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="memory-based-stores">Memory-Based Stores<a class="hash-link" href="#memory-based-stores" title="Direct link to heading">​</a></h5><p>速度快，但内存价格贵，且易失</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="disk-based-database">Disk-Based Database<a class="hash-link" href="#disk-based-database" title="Direct link to heading">​</a></h5><p>磁盘的随机存取比内存随机存取慢得多，因此磁盘存储结构通常都是树结构，内存数据库数据结构则更加多样。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="column---vs-row--oriented-dbms">Column - vs Row- Oriented DBMS<a class="hash-link" href="#column---vs-row--oriented-dbms" title="Direct link to heading">​</a></h5><p>通常数据库都存着数据记录的集合，包括行、列以及它们的交点——Field。</p><p><img alt="dbin 0102" src="/assets/images/dbin_0102-728f00e7a6fa55c085b777ae55603558.png" width="2817" height="639"></p><p>行存储的数据库很多，比如MySQL，Postgres</p><p>列存储如MonetDB C-Store，Apache Druid</p><p>在存储上，行存储在聚合查询时，会把不必要的列也拿出来，增加开销。列存储则更适合聚合，同一种数据类型存储在一起也会最大化压缩效率（对不同类型选择不同压缩算法）。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="wide-column-store">Wide Column Store<a class="hash-link" href="#wide-column-store" title="Direct link to heading">​</a></h5><p>如 BigTable 和HBase</p><p>不要和Column oriented混淆了。</p><p>Wide Column Store其实是对columns进行分组，每个分组内部还是row-wise store.</p><p><img alt="dbin 0104" src="/assets/images/dbin_0104-422e8b43a62b9717860388b6551f04a2.png" width="1439" height="604"></p><h5 class="anchor anchorWithStickyNavbar_mojV" id="data-files-and-index-files">Data files and Index files<a class="hash-link" href="#data-files-and-index-files" title="Direct link to heading">​</a></h5><p>data files存储records，index files存储meta数据</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="data-files">Data files<a class="hash-link" href="#data-files" title="Direct link to heading">​</a></h5><p>多种形式，如</p><p>Index Organized Tables</p><p>Heap Organized Tables</p><p>Hash Organized Tables</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="index-file">Index file<a class="hash-link" href="#index-file" title="Direct link to heading">​</a></h5><p>在Primary data file上的index就称作Primary Index。</p><p>Secondary index可以直接指向数据record，也可以只存Primary key。</p><p>Clustered and Nonclustered：有序和无序</p><p><img alt="dbin 0105" src="/assets/images/dbin_0105-bc75954874128bba1c892090502be790.png" width="5700" height="1470"></p><p>在数据表没有指定primary key时，数据库会默认创建一列主键</p><p>如果Index直接指向数据，在读取时确实减少了读盘次数，但更新时需要直接更新指针，对于Write heavy的应用来说，开销是非常大的。而Mysql InnoDB使用了两次查找的方式，Secondary Index和Primary Index。</p><p><img alt="dbin 0106" src="/assets/images/dbin_0106-a732429f9e02c9448b0008a1d172b264.png" width="2991" height="1176"></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="b-tree">B-Tree<a class="hash-link" href="#b-tree" title="Direct link to heading">​</a></h4><p>introduced by Rudolph Bayer and Edward M. McCreight back in 1971</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="binary-search-treesbst">Binary Search Trees(BST)<a class="hash-link" href="#binary-search-treesbst" title="Direct link to heading">​</a></h5><p><img alt="dbin 0202" src="/assets/images/dbin_0202-b237d34970a8b9e60a7ece0649b2e0ea.png" width="608" height="434"></p><h5 class="anchor anchorWithStickyNavbar_mojV" id="tree-balancing">Tree Balancing<a class="hash-link" href="#tree-balancing" title="Direct link to heading">​</a></h5><p><img alt="dbin 0203" src="/assets/images/dbin_0203-1f964eab01828da3375e219fe1e03925.png" width="1441" height="538"></p><p>平衡 vs 不平衡 树</p><p>如果树退化了，查找复杂度就不再是Log~2~N而是N了。</p><p>二叉树旋转，中间的节点作为轴，旋转成为新的父节点</p><p><img alt="dbin 0204" src="/assets/images/dbin_0204-750f737696b29101629496872e4b8829.png" width="847" height="360"></p><p>然而，BST有几个问题：</p><p>首先，每次插入都需要做平衡操作，读写开销都很大。</p><p>其次，父节点不一定存在子节点附近，如果相差很远，就需要到别的扇区读取，增加寻道时间。</p><p>所以，需要两点改进：</p><p>1、增加子节点数量，不再是2个</p><p>2、降低树的高度，减少seek次数</p><p><img alt="dbin 0207" src="/assets/images/dbin_0207-99008f11b13f62f14a876439dd1e044c.png" width="2817" height="468"></p><p><img alt="dbin 0209" src="/assets/images/dbin_0209-8611a4b83ce9e3f04861fd6f53b096a4.png" width="4014" height="1128"></p><p>B-Tree在任何层级都可以存储数据，而B+-Tree只在叶节点存数据。</p><p>InnoDB将B+-Tree实现也称为B-Tree</p><p>B-Tree 的构建是从Bottom to top，不像BST是从Top to bottom</p><p><img alt="dbin 0210" src="/assets/images/dbin_0210-bd313d6a54d73011abaa03e269d74aec.png" width="1440" height="465"></p><p>有些B-Tree叶节点也会包含指向兄弟节点的指针，有些是双向指针，使得最底层的叶节点也称为一个双向链表。</p><p>当节点插入的数据超过一个阈值，就会触发分裂。</p><p>当相邻节点的数据量低于N，就可以触发合并。</p><p>我们希望B-Tree也能存储在硬盘上，但是内存里的数据存储形式不是很关键，因为内存的随机存取速度很快。在硬盘上，我们就需要考虑垃圾回收，碎片整理等情况。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="big-little-endian">Big Little Endian<a class="hash-link" href="#big-little-endian" title="Direct link to heading">​</a></h5><p><img alt="dbin 0301" src="/assets/images/dbin_0301-d1c8039931b15a0169724b99908a34e6.png" width="1441" height="182"></p><p>文件结构</p><p><img alt="dbin 0303" src="/assets/images/dbin_0303-5c5b241b533d2eb52f37b9d0200a096b.png" width="1439" height="385"></p><p>Header和Trailer都包含一些辅助信息，用于解密数据等</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="simple-page-organization">Simple Page Organization<a class="hash-link" href="#simple-page-organization" title="Direct link to heading">​</a></h5><p><img alt="dbin 0304" src="/assets/images/dbin_0304-d01fd3c4874813d08100c042bf9a8f1b.png" width="1439" height="126"></p><p>有一些问题：</p><p>增加Key就涉及到移动元素</p><p>只适合固定长度的数据，不能够存取变长数据</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="slotted-pages">Slotted Pages<a class="hash-link" href="#slotted-pages" title="Direct link to heading">​</a></h5><p><img alt="dbin 0305" src="/assets/images/dbin_0305-09721a0777d45465519889aff39caba9.png" width="906" height="704"></p><p>在每一个Page中，有一个Page header,包含Page和Cell的信息。然后Cell里面存储了一些数据，可以是任意数据。Pointers指向cell。</p><p>Cell的好处在于，在删除的时候只需要指针置空就好了，然后数据长度也是不固定的。碎片和不连续空间只需要重新写一遍Page就可以得到处理。</p><p>而且，如果需要排序，只需要对Pointer排序就可以，不需要对实际数据进行重新排序。</p><p><img alt="dbin 0309" src="/assets/images/dbin_0309-79078a70b2fed851d9988b57d7c434ac.png" width="1441" height="435"></p><p>所有的空闲区域组成一个Availability List。SQLite会存储指向第一个空闲块的指针。</p><p>新的数据插入，会遵循两种:</p><p>First Fit或者Best Fit，来尝试插入。</p><p>如果defragmentation之后，还是无法插入，就需要创建Overflow Page。</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="page-header">Page Header<a class="hash-link" href="#page-header" title="Direct link to heading">​</a></h4><h5 class="anchor anchorWithStickyNavbar_mojV" id="magic-numbers">Magic Numbers<a class="hash-link" href="#magic-numbers" title="Direct link to heading">​</a></h5><p>代表page的id，类型或者版本。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="sibling-links">Sibling Links<a class="hash-link" href="#sibling-links" title="Direct link to heading">​</a></h5><p>不必再去访问父节点来得到兄弟节点的信息</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="rightmost-pointers">Rightmost Pointers<a class="hash-link" href="#rightmost-pointers" title="Direct link to heading">​</a></h5><p><img alt="dbin 0402" src="/assets/images/dbin_0402-d74a04e406bbb7c940333fb033c522bf.png" width="1440" height="465"></p><h5 class="anchor anchorWithStickyNavbar_mojV" id="node-high-keys">Node High Keys<a class="hash-link" href="#node-high-keys" title="Direct link to heading">​</a></h5><p><img alt="dbin 0405" src="/assets/images/dbin_0405-9bbd290a1b5bc08f7b181582156b6c72.png" width="1440" height="428"></p><p>指针可以成对出现，直接指向叶节点，代表叶节点的最值</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="overflow-page">Overflow Page<a class="hash-link" href="#overflow-page" title="Direct link to heading">​</a></h5><p><img alt="dbin 0406" src="/assets/images/dbin_0406-bedd63b1462fe046de2a6a91fc37b99a.png" width="802" height="918"></p><h5 class="anchor anchorWithStickyNavbar_mojV" id="breadcrumbs">Breadcrumbs<a class="hash-link" href="#breadcrumbs" title="Direct link to heading">​</a></h5><p><img alt="dbin 0408" src="/assets/images/dbin_0408-5fe1bf37661ea088c5e12c91610a98dc.png" width="1440" height="1327"></p><p>Header中存上遍历到这个节点的路径经过的节点，用于链式合并、分解节点</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="right-only-appends">Right-Only Appends<a class="hash-link" href="#right-only-appends" title="Direct link to heading">​</a></h5><p>如果添加的数据比最右Page的值还大，那么就可以省略查找路径的过程，直接在最右节点增加数据(Postgres)或者创建一个新的最右节点(SQLite)，然后添加到父节点。</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="acid">ACID<a class="hash-link" href="#acid" title="Direct link to heading">​</a></h4><p>Atomicity 事务步骤是不可分割的，所有步骤成功或者都不成功。</p><p>Consistency 让数据库从一个有效状态更新到另一个有效状态，应用层</p><p>Isolation 多个并发事务应当互相不干扰。</p><p>Durability 所有更改应当能够持久化到磁盘</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="cache-eviction">Cache Eviction<a class="hash-link" href="#cache-eviction" title="Direct link to heading">​</a></h5><p>当Cache中的page被修改过后，它会被置脏。因此，在evict脏page时，需要先flush到磁盘，再evict。</p><p>如果每一次eviction都做flush显然开销太大，PostgreSQL有一个后台进程定时去执行任务。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="pinned-pages">Pinned Pages<a class="hash-link" href="#pinned-pages" title="Direct link to heading">​</a></h5><p>由于B-Tree的特性，最上层的节点几乎总是被访问到，因此将它们持久缓存是收益很大的。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="page-replacement">Page Replacement<a class="hash-link" href="#page-replacement" title="Direct link to heading">​</a></h5><p>FIFO LRU Clock</p><p>Clock</p><p><img alt="dbin 0502" src="/assets/images/dbin_0502-76128854194f2b785fe5dd95e20f1640.png" width="1438" height="1438"></p><p>如果指针指向的Page目前没有被访问(灰色的正在被引用，白色不在被引用)，将它的访问bit 置为0.如果已经是0，那么准备eviction。</p><p>LFU Least Frequently Used</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recovery">Recovery<a class="hash-link" href="#recovery" title="Direct link to heading">​</a></h4><p><em>write-ahead log</em> (commit log) 只追加，不可修改</p><p>每一条record 都有一个log sequence number(LSN)</p><p>所有数据库的写操作都要事先Log,然后才能修改Page</p><p>Page Cache能够重建</p><p>Log Checkpoint，标记到N开始的log已经被持久化，不再需要了。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="steal-and-force">Steal and force<a class="hash-link" href="#steal-and-force" title="Direct link to heading">​</a></h5><p>Steal：允许还未完成事务的page flush到磁盘上。</p><p>Force： 在事务commit之前，所有修改的Page必须被flush到磁盘上</p><p>如果设置了no-steal，那么只需要redo log就可以恢复数据库</p><p>设置了force，transaction会慢的多，但重建就相对简单。</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="concurrency-control">Concurrency Control<a class="hash-link" href="#concurrency-control" title="Direct link to heading">​</a></h4><p>Optimistic concurrency control </p><p>如果多个事务的执行结果有分歧，其中的一个会被丢弃。所有事务都被允许并发读写，然后判断结果</p><p>Multiversion concurrency</p><p>timestamp顺序，允许多个时间点的版本共存。</p><p>Pessimistic concurrency control</p><p>lock-based: 防止其他事务修改加锁的纪录</p><p>Nonlocking: 维护一个列表，顺序执行</p><p>可能出现死锁问题</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="serializable-schedule">Serializable schedule<a class="hash-link" href="#serializable-schedule" title="Direct link to heading">​</a></h5><p><img alt="dbin 0504" src="/assets/images/dbin_0504-196d53a3115d645c2dd87f396c672340.png" width="1438" height="450"></p><p>多个transaction按任意顺序执行，one by one</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="isolation-levels">Isolation Levels<a class="hash-link" href="#isolation-levels" title="Direct link to heading">​</a></h5><p>最低级别的isolation是read uncommitted，允许transaction读取dirty reads</p><p><img alt="dbin 0505" src="/assets/images/dbin_0505-948ca50cf6b1b453531b3db4dd63a9c1.png" width="1439" height="300"></p><h5 class="anchor anchorWithStickyNavbar_mojV" id="optimistic-concurrency-control">Optimistic Concurrency Control<a class="hash-link" href="#optimistic-concurrency-control" title="Direct link to heading">​</a></h5><p>假设事务冲突很少，我们不需要加锁，只需要验证事务的合法性来判断是否commit。</p><p>事务被分为三步：</p><p>Read, Validation, Write</p><p>Backward-oriented 检查与已经commit的事务是否冲突</p><p>Forward-oriented 检查正在进行validation的事务是否冲突</p><p>只要有其他事务正在被validate，现在的事务就不允许commit。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="multiversion-concurrency-control">Multiversion Concurrency Control<a class="hash-link" href="#multiversion-concurrency-control" title="Direct link to heading">​</a></h5><p>区分committed 和uncomitted的版本，对应committed和uncommitted的事务。</p><p>最后一个committed的版本就是current。</p><p>通常来说，目标就是至多有一个uncommitted值。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="pessimistic-concurrency-control">Pessimistic Concurrency Control<a class="hash-link" href="#pessimistic-concurrency-control" title="Direct link to heading">​</a></h5><p>time-stamp ordering：如果时间戳更晚的事务已经提交，当前事务就只能取消</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="lock-based-concurrency-control">Lock-Based Concurrency Control<a class="hash-link" href="#lock-based-concurrency-control" title="Direct link to heading">​</a></h5><p>Two-phase locking(2PL)</p><p>Growing phase: 取得所有需要的锁</p><p>Shrinking phase：释放所有取得的锁</p><p>解决死锁：</p><p>追踪依赖图是否有环</p><p>超时、裁定优先级</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="locks-and-latches">Locks and Latches<a class="hash-link" href="#locks-and-latches" title="Direct link to heading">​</a></h5><p>Locks：逻辑数据一致性, content</p><p>Latch: 物理数据一致性， page level</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="rw-lock">RW Lock<a class="hash-link" href="#rw-lock" title="Direct link to heading">​</a></h5><p><img alt="dbin 0507" src="/assets/images/dbin_0507-7173061759e5e3becca4b66bbed9e7fc.png" width="1261" height="359"></p><h5 class="anchor anchorWithStickyNavbar_mojV" id="copy-on-write">Copy-on-write<a class="hash-link" href="#copy-on-write" title="Direct link to heading">​</a></h5><p>当数据即将被修改时，创建一个备份，然后修改备份。</p><p>这样Reader读到的还是原本，不需要同步。</p><p>缺点就是占用空间较大</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="lazy-b-tree">Lazy B-Tree<a class="hash-link" href="#lazy-b-tree" title="Direct link to heading">​</a></h5><p><img alt="dbin 0602" src="/assets/images/dbin_0602-b64654b6992647612351a4589a2b2eb4.png" width="2673" height="882"></p><p>读写都会在缓存中进行，然后定期flush到树中持久化</p><p>由于split 和merge转到后台运行，r/w操作不需要等待。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="lazy-adaptive-tree">Lazy Adaptive Tree<a class="hash-link" href="#lazy-adaptive-tree" title="Direct link to heading">​</a></h5><p>每个node都有一个buffer，当根节点buffer满了，就会写到子树的buffer，一直推到叶节点。</p><p><img alt="dbin 0604" src="/assets/images/dbin_0604-5ea39eb67bd6d3f5cbbc3d0853631b39.png" width="4137" height="1851"></p><h5 class="anchor anchorWithStickyNavbar_mojV" id="fd-tree">FD-Tree<a class="hash-link" href="#fd-tree" title="Direct link to heading">​</a></h5><p>假设有下列几个数组：</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">A1 = [12, 24, 32, 34, 39]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">A2 = [22, 25, 28, 30, 35]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">A3 = [11, 16, 24, 26, 30]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>每个数组都向下方的数组抽元素，填充到自己的元素中</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">A1 = [12, 24, 25, 30, 32, 34, 39]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">A2 = [16, 22, 25, 26, 28, 30, 35]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">A3 = [11, 16, 24, 26, 30]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><img alt="dbin 0605" src="/assets/images/dbin_0605-ebaab3c57c835312e5cc952f3ec0e59a.png" width="1080" height="780"></p><p>这种连接方式被称为Bridge，可以大大缩小查找空间。</p><p><img alt="dbin 0606" src="/assets/images/dbin_0606-c1bf7860be20534985119fac842940dd.png" width="6627" height="1332"></p><h5 class="anchor anchorWithStickyNavbar_mojV" id="bw-tree">Bw-Tree<a class="hash-link" href="#bw-tree" title="Direct link to heading">​</a></h5><p><img alt="dbin 0607" src="/assets/images/dbin_0607-0e403e4ee43aca6019418cf11f8c85a6.png" width="3345" height="681"></p><p>Update chain包含修改信息，Base node不做in place 修改</p><p>这样如果要更换事务顺序，只需要compare and swap，更换Update chain里的pointer就可以了。</p><p>Update chain在达到阈值后，就需要merge base node with deltas，写到新的page上然后改变父节点的指针。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="lsm-tree">LSM-Tree<a class="hash-link" href="#lsm-tree" title="Direct link to heading">​</a></h5><p>Append-only </p><p>因此insert update delete不需要定位到磁盘上的record，显著提升写性能和吞吐量。</p><p>允许重复数据，冲突在读时解决</p><p>LSM Tree在写比读更多时很常用</p><p>简而言之，In-place update对读更友好，写则需要定位到位置。</p><p>Append-only对写更友好，但读取时需要取到多个版本的数据然后整合。</p><p>B-Tree也经常作为LSM Tree的索引结构</p><p>LSM树将数据的写缓存到内存里的表结构中。读和写分离，所以读写可以同时进行。</p><p>当LSM树接收到写请求后，存到mutable memtable中，buffer and sort。达到一定阈值后，持久化到磁盘。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="two-and-multi-component-lsm-trees">Two and Multi component LSM Trees<a class="hash-link" href="#two-and-multi-component-lsm-trees" title="Direct link to heading">​</a></h5><p>Two component只有一个磁盘树。对每个内存中的子树，都和磁盘中对应的子树合并，生成一个新的子树写到新的磁盘区域。当子树被flush之后，之前的树就被丢弃了，取而代之的是新的树。</p><p><a href="https://kernelmaker.github.io/lsm-tree" target="_blank" rel="noopener noreferrer">【Paper笔记】The Log structured Merge-Tree（LSM-Tree） · (kernelmaker.github.io)</a></p><p>Multicomponent </p><p><img alt="dbin 0703" src="/assets/images/dbin_0703-770dd5396041a8ae92b3bc62ee9c96af.png" width="1440" height="354"></p><p><img alt="dbin 0704" src="/assets/images/dbin_0704-25746020c13b095465b16273776dd69d.png" width="1440" height="599"></p><p>在LSM中，Update和Insert是无法区分的，因此可以称作Upsert</p><p>Compaction</p><p>根据树的层级进行整合</p><p><img alt="dbin 0706" src="/assets/images/dbin_0706-7ad2540683188832bd35f12e43f6c513.png" width="2643" height="735"></p><p>LSM的disk-resident table是SSTable( Sorted String Table)，一般包含一个index file和 data file，index file可以使用B-Tree或哈希表。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="bloom-filter">Bloom Filter<a class="hash-link" href="#bloom-filter" title="Direct link to heading">​</a></h5><p>使用一个大型的bit array，多个哈希函数。</p><p>对每个record的键进行哈希操作，把得到结果作为下标的位置为1。</p><p>如果给定一个key，所有哈希函数对它求哈希值后对应的位都是1，那么它<strong>很有可能</strong>在这个集合中，否则只要有1个出现0，那么它<strong>一定</strong>不在集合中。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="skiplist">Skiplist<a class="hash-link" href="#skiplist" title="Direct link to heading">​</a></h5><p><img alt="dbin 0708" src="/assets/images/dbin_0708-6f10cb239f9f5c1bc9c61ab87cf5a062.png" width="1441" height="185"></p><p>每个节点的高度都是随机的。</p><p>假如从10出发，找7。</p><p>1、10&gt;7，回退到下一层的上一个节点</p><p>2、到达5，5&lt;7，前进，又回到10，还是比7大，回退下一层的上一个节点</p><p>3、到达7</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="keydir">Keydir<a class="hash-link" href="#keydir" title="Direct link to heading">​</a></h5><p><img alt="dbin 0711" src="/assets/images/dbin_0711-8459c651f8dbb47fba77d26cea4736f7.png" width="1439" height="855"></p><p><img alt="dbin 0001" src="/assets/images/dbin_0001-06eebc7e8fa027ef72f318e2859990e9.png" width="1441" height="997"></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/database/database_internals.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/database/Oracle"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Oracle</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/database/mongodb"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">MongoDB</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.ad57eab9.js"></script>
<script src="/assets/js/main.878a9392.js"></script>
</body>
</html>