<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Hyc3z&#39;s blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Hyc3z&#39;s blog Atom Feed"><title data-react-helmet="true">kafka | Hyc3z&#x27;s blog</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://hyc3z.github.io/docs/big-data/kafka"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="kafka | Hyc3z&#x27;s blog"><meta data-react-helmet="true" name="description" content="kafka简介"><meta data-react-helmet="true" property="og:description" content="kafka简介"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://hyc3z.github.io/docs/big-data/kafka"><link data-react-helmet="true" rel="alternate" href="https://hyc3z.github.io/docs/big-data/kafka" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://hyc3z.github.io/docs/big-data/kafka" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.366311be.css">
<link rel="preload" href="/assets/js/runtime~main.fb9af459.js" as="script">
<link rel="preload" href="/assets/js/main.47f840b1.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Hyc3z&#x27;s blog</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Notes</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/hyc3z" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Hyc3z<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">🌜</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">🌞</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">intro</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/cpp/pcal">cpp</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/blockchain/Chainlink">blockchain</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/ai/deep_learning">ai</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_VCh3" aria-current="page" href="/docs/big-data/hadoop">big-data</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/big-data/hadoop">hadoop</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/big-data/kafka">kafka</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/cryptography/overview">cryptography</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/database/Oracle">database</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/data/data_science">data</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" href="/docs/git/">git</a><button aria-label="Toggle the collapsible sidebar category &#x27;git&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/design/microservices">design</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/graph/graph-database">graph</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/python/re">python</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/ts/typescript">ts</a></div></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>kafka</h1></header><h3 class="anchor anchorWithStickyNavbar_mojV" id="kafka简介"><a href="https://zhuanlan.zhihu.com/p/37405836" target="_blank" rel="noopener noreferrer">kafka简介</a><a class="hash-link" href="#kafka简介" title="Direct link to heading">​</a></h3><p>Kafka最早诞生是为了解决Linkedin的data pipeline问题。</p><p><a href="https://engineering.linkedin.com/distributed-systems/log-what-every-software-engineer-should-know-about-real-time-datas-unifying" target="_blank" rel="noopener noreferrer">log</a></p><p>数据处理最重要的是有一个完整的数据流，而不是数据模型</p><p>日志充当了一个缓存作用，使得读写可以异步</p><p>Data which is collected in batch is naturally processed in batch. When  data is collected continuously, it is naturally processed continuously. </p><p><img alt="kdg2 0102" src="/assets/images/kdg2_0102-3ff1d183894dec028ba940ac5c22c527.png" width="600" height="202"></p><p><img alt="kdg2 0103" src="/assets/images/kdg2_0103-d273072b356aca9371f513a329584120.png" width="600" height="242"></p><p>使用Kafka的优势是显而易见的：不需要再去做各种各样的routing和wiring，就能将metrics通过统一的平台进行统计、分析和分发。</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="schema">Schema<a class="hash-link" href="#schema" title="Direct link to heading">​</a></h4><p>Kafka的消息都是字节数组，但是也是有结构定义的。</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="stream">Stream<a class="hash-link" href="#stream" title="Direct link to heading">​</a></h4><p><img alt="kdg2 0105" src="/assets/images/kdg2_0105-f0095512f3a6e6e3d6319de7731a6f27.png" width="600" height="202"></p><p>Stream指的是同一个Topic的消息，和Partition的数量无关。同一个消息可以有多个Partition，也可以分散在多个节点上，提升性能和冗余度。</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="producer-consumer">Producer Consumer<a class="hash-link" href="#producer-consumer" title="Direct link to heading">​</a></h4><p>Producer指的就是消息的生产者，通常会平均地向每个Partition分摊消息。但也有特殊情况，生产者只会向特定的Partition发送消息。</p><p>Consumer读取消息，订阅一个或多个Topic，按顺序读取消息。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="offset">Offset<a class="hash-link" href="#offset" title="Direct link to heading">​</a></h5><p>Consumer和Kafka都保留了一个Offset，一个不完全单调递增的int，后来的消息offset更大。每个partition的offset都被保存着，这样Consumer暂停接受消息后，就可以resume。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="consumer-group">Consumer group<a class="hash-link" href="#consumer-group" title="Direct link to heading">​</a></h5><p>一个或多个Consumer共同消费同一个topic。Consumer group确保每个partition只会被一个member消费。这也被称为Ownership。</p><p><img alt="kdg2 0106" src="/assets/images/kdg2_0106-83073a5adf405a3bbffdc36ef66cfb92.png" width="600" height="246"></p><p>如果一个member fail了，那个partition会被重新分配到剩余的members中。</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="brokers-and-clusters">Brokers and Clusters<a class="hash-link" href="#brokers-and-clusters" title="Direct link to heading">​</a></h4><p><img alt="kdg2 0107" src="/assets/images/kdg2_0107-b4ebe8f1030867ba5db2a5ee89de5fdc.png" width="600" height="359"></p><p>Broker从producer接受消息，设置offset，然后写入存储。消息有主从同步。</p><p>消息有存储限制和时长限制，超出了就会被删掉。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="mirrormaker">MirrorMaker<a class="hash-link" href="#mirrormaker" title="Direct link to heading">​</a></h5><p><img alt="kdg2 0108" src="/assets/images/kdg2_0108-6511d0382ca6da80e989d49e18c6ef1e.png" width="600" height="419"></p><p>灾备的MirrorMaker本身就是一个consumer和producer，consume其他集群的消息然后produce到本地集群。</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="优势">优势<a class="hash-link" href="#优势" title="Direct link to heading">​</a></h4><p>多Producer，多Consumer，本地留存。</p><p>高性能，高可用</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="生态">生态<a class="hash-link" href="#生态" title="Direct link to heading">​</a></h4><p><img alt="kdg2 0109" src="/assets/images/kdg2_0109-4b5a0ebf4c022d05751181192c3b5a7e.png" width="600" height="454"></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="zookeeper">Zookeeper<a class="hash-link" href="#zookeeper" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_mojV" id="消息队列的挑战">消息队列的挑战<a class="hash-link" href="#消息队列的挑战" title="Direct link to heading">​</a></h4><h5 class="anchor anchorWithStickyNavbar_mojV" id="消息延迟">消息延迟<a class="hash-link" href="#消息延迟" title="Direct link to heading">​</a></h5><p>​	P比Q先发送消息，但Q的消息先到</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="处理速度">处理速度<a class="hash-link" href="#处理速度" title="Direct link to heading">​</a></h5><p>​	T~ps~ + T~s~ + T~pr~ 时延 = 发送+传输+接受</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="时钟对齐">时钟对齐<a class="hash-link" href="#时钟对齐" title="Direct link to heading">​</a></h5><p>​	处理器时钟有可能不准，或者未对齐</p><p>​	</p><p>​	消息没收到，有可能是三种情况的任意一种</p><p>​	</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="主从结构">主从结构<a class="hash-link" href="#主从结构" title="Direct link to heading">​</a></h4><h5 class="anchor anchorWithStickyNavbar_mojV" id="主节点crash">主节点crash<a class="hash-link" href="#主节点crash" title="Direct link to heading">​</a></h5><p>​	需要备用Master，新的Master能够从crash时的状态恢复。此时，我们不能指望从crash掉的master那里读取恢复时的context，所以需要把数据存在别的地方，就是zookeeper里。</p><p>​	<em>split-brain</em> 一个系统中两个或多个部分独立地完成工作，比如master实际在工作，但由于网络故障，集群被划分为了两半。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="worker-crash">Worker crash<a class="hash-link" href="#worker-crash" title="Direct link to heading">​</a></h5><p>​	重新分配调度给Worker的任务。任务可能执行了一半，也可能已经完成但无法汇报结果。如果有Side effect，那么还需要清理状态。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="通讯故障">通讯故障<a class="hash-link" href="#通讯故障" title="Direct link to heading">​</a></h5><p>​	锁不能解决问题</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="具体功能">具体功能<a class="hash-link" href="#具体功能" title="Direct link to heading">​</a></h4><h5 class="anchor anchorWithStickyNavbar_mojV" id="master-election">Master election<a class="hash-link" href="#master-election" title="Direct link to heading">​</a></h5><p>​	拥有master才具有分配任务的功能，所以必须能够选举</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="crash-detection">Crash detection<a class="hash-link" href="#crash-detection" title="Direct link to heading">​</a></h5><p>​	Master能够检测到worker crash</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="group-membership-management">Group membership management<a class="hash-link" href="#group-membership-management" title="Direct link to heading">​</a></h5><p>​	Master能够得知哪些节点能够执行任务</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="metadata-management">Metadata management<a class="hash-link" href="#metadata-management" title="Direct link to heading">​</a></h5><p>​	主节点和从节点都能够存储分配和执行状态</p><p>Zookeeper 并不是 Byzantine fault tolerant的，因为这会大大增加复杂性和开销。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="fischer-lynch-and-patterson-flp">Fischer, Lynch, and Patterson FLP<a class="hash-link" href="#fischer-lynch-and-patterson-flp" title="Direct link to heading">​</a></h5><p>异步通信，并且会故障的进程，并没有办法对哪怕1bit的信息达成共识。</p><p>Impossibility of Distributed Consensus with One Faulty Process， 1983</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="znode-tree">ZNode tree<a class="hash-link" href="#znode-tree" title="Direct link to heading">​</a></h4><p><img alt="ZooKeeper data tree example." src="/assets/images/zook_0201-f348c18600f23040fc76ea4ecbd16b0b.png" width="952" height="855"></p><p>Znode的所有信息都被存在一棵树里，包括Master，Workers，Tasks和Assign。</p><p>如果有数据缺失，就说明有地方出错了。比如Master这里的值是空，就说明需要进行Leader election。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="事物原子性">事物原子性<a class="hash-link" href="#事物原子性" title="Direct link to heading">​</a></h5><p>Zookeeper有API可以对数据进行读写，但读或者写操作都是原子性的。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="polling-vs-notification">Polling vs Notification<a class="hash-link" href="#polling-vs-notification" title="Direct link to heading">​</a></h5><p>Polling:</p><p><img alt="Multiple reads to the same znode./img/foo" src="/assets/images/zook_0202-13e643b8ad36e9e732adb6d0f56baccb.png" width="1475" height="717"></p><p>可以看到，操作2是不必要的。</p><p>Notification:</p><p><img alt="Using notifications to indicate changes to a znode" src="/assets/images/zook_0203-b68ec627cd5555c1daa34ec82c658ffc.png" width="1430" height="653"></p><h5 class="anchor anchorWithStickyNavbar_mojV" id="version-number">Version Number<a class="hash-link" href="#version-number" title="Direct link to heading">​</a></h5><p>每个Znode都有一个版本号</p><p><img alt="Using versions to prevent inconsistencies due to concurrent updates" src="/assets/images/zook_0204-ca2ed752621e26578f07df89dfb7addb.png" width="1557" height="685"></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="与application-交互">与Application 交互<a class="hash-link" href="#与application-交互" title="Direct link to heading">​</a></h4><p><img alt="ZooKeeper Architecture Overview." src="/assets/images/zook_0205-8ffc44a8ecad7e5122d3e4779a25b3e4.png" width="867" height="803"></p><p>Standalone mode：一个Zookeeper server</p><p>Quorum mode: 多个servers，states replicate</p><p>多数server确认状态被复制，才能成功更新状态，避免split-brain</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="leader-election">Leader Election<a class="hash-link" href="#leader-election" title="Direct link to heading">​</a></h4><p>Looking state，Follower state 和 Leader state三种状态</p><p>发现Leader 挂掉，马上进入looking state，然后互相给每个resemble 里的server发消息，是一个tuple包含自己的serverID(sID)和上一个请求的transaction ID(zxID)。然后对比，选出最新处理请求的当选leader</p><p><img alt="Leader election illustration." src="/assets/images/zook_0901-0b72139b0918b4fd1bda227adde8f74b.png" width="1272" height="675"></p><p>但是这样做是建立在选举时网络条件很好的情况下。</p><p><img alt="Leader election illustration." src="/assets/images/zook_0902-6d04d36e7bd7de5efc353b8b4114cd66.png" width="1269" height="675"></p><p>如果网络有延迟，就会出现这样的情况。因此，可以加上一个超时，设定等待的最长时间。Fast Election就设置了200ms</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="zab-the-zookeeper-atomic-broadcast-protocol"><em>Zab</em>: the ZooKeeper Atomic Broadcast protocol<a class="hash-link" href="#zab-the-zookeeper-atomic-broadcast-protocol" title="Direct link to heading">​</a></h4><ul><li>首先，Leader会向所有Follower发送一个Proposal 信息</li><li>Follower向Leader 发送 ACK</li><li>Leader 向Follower 发送 Commit</li></ul><p><img alt="Regular message pattern to commit proposals." src="/assets/images/zook_0904-4ffadd2e45da58b58d5f305a2fd774de.png" width="1269" height="669"></p><p>这样做能确保事务的处理顺序，并且不遗漏事务。</p><p>Epoch：代表Leader的term，每次leader election都会增加epoch，每次transaction都会包含epoch</p><p>DIFF：转换Epoch时，如果相差不多，Leader会发送Follower缺失的transaction。</p><p>SNAP：相差很大，Leader会发送全量的snapshot</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="observers">Observers<a class="hash-link" href="#observers" title="Direct link to heading">​</a></h5><p>不参与投票，不参与proposal</p><p><img alt="Illustration of the leader server pipeline." src="/assets/images/zook_0907-3fbb513b423536af2d921cd060835337.png" width="1531" height="396"></p><p>Master在处理完Proposal后，会同时处理Commit以及持久化到本地</p><p>回到Kafka，kafka的broker就是在zookeeper中以<em>/brokers/ids</em>的形式注册的。</p><p>由于ephemeral node的特性，当broker失联了，session断开，它的节点就会被zookeeper自动移除。</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="controller">Controller<a class="hash-link" href="#controller" title="Direct link to heading">​</a></h4><p>broker+ partition leader election，每个cluster只会同时有一个controller。</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="kraft">KRaft<a class="hash-link" href="#kraft" title="Direct link to heading">​</a></h4><p>2019年开始的项目</p><p>现有问题：</p><ul><li>Metadata同步写入ZooKeeper，分发给broker却是异步。因此存在broker，controller，zookeeper三者状态不一致的情况</li><li>当controller重启时，需要重新从zookeeper读全量的状态数据，非常慢。</li><li>Ownership不明确，同样的数据有些是controller改的，有些是broker改的，有些是zookeeper改的</li><li>Zookeeper本身也是一个分布式系统</li></ul><p>解决方法:</p><p>KRaft，将controller分为 active controller 和follower controllers，active controller负责处理broker事务。</p><p>Controller nodes自己leader election，原本存储在zookeeper的数据存在一个log中。</p><p><a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-500%3A+Replace+ZooKeeper+with+a+Self-Managed+Metadata+Quorum#KIP500:ReplaceZooKeeperwithaSelfManagedMetadataQuorum-MetadataasanEventLog" target="_blank" rel="noopener noreferrer">KIP-500: Replace ZooKeeper with a Self-Managed Metadata Quorum - Apache Kafka - Apache Software Foundation</a></p><p><a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-595%3A+A+Raft+Protocol+for+the+Metadata+Quorum" target="_blank" rel="noopener noreferrer">KIP-595: A Raft Protocol for the Metadata Quorum - Apache Kafka - Apache Software Foundation</a></p><p><a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-631%3A+The+Quorum-based+Kafka+Controller" target="_blank" rel="noopener noreferrer">KIP-631: The Quorum-based Kafka Controller - Apache Kafka - Apache Software Foundation</a></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="partition-replicas">Partition Replicas<a class="hash-link" href="#partition-replicas" title="Direct link to heading">​</a></h4><p>每个Topic 可以有多个Partition，而每个Partition可以有多个replica。</p><p>Replica也分主从，主负责处理client request，从复制消息并且作为备份。</p><p>KIP-392之后，follower partition也可以处理client request。 </p><p><a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-392%3A+Allow+consumers+to+fetch+from+closest+replica" target="_blank" rel="noopener noreferrer">KIP-392: Allow consumers to fetch from closest replica - Apache Kafka - Apache Software Foundation</a></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="requests">Requests<a class="hash-link" href="#requests" title="Direct link to heading">​</a></h4><p><a href="https://www.confluent.io/blog/apache-kafka-purgatory-hierarchical-timing-wheels/" target="_blank" rel="noopener noreferrer">Apache Kafka, Purgatory, and Hierarchical Timing Wheels | Confluent</a></p><p>Request type (also called API key)</p><p>Request version (so the brokers can handle clients of different versions and respond accordingly)</p><p>Correlation ID: a number that uniquely identifies the request and also appears in the response and in the error logs (the ID is used for troubleshooting)</p><p>Client ID: used to identify the application that sent the request</p><p><a href="https://kafka.apache.org/protocol.html" target="_blank" rel="noopener noreferrer">Apache Kafka</a></p><p>由于Client并不知道要向哪个partition发消息，所以需要metadata request，然后broker返回topic，partition以及leader的信息。</p><p><img alt="kdg2 0602" src="/assets/images/kdg2_0602-3351456e97e886ce96f0102eea845e08.png" width="600" height="390"></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="produce-request">Produce request<a class="hash-link" href="#produce-request" title="Direct link to heading">​</a></h4><p>Acks=&lt;0,1,all&gt;</p><p>不等待，只等待leader，等待所有replica sync</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="fetch-request">Fetch request<a class="hash-link" href="#fetch-request" title="Direct link to heading">​</a></h4><h5 class="anchor anchorWithStickyNavbar_mojV" id="zero-copy">zero-copy<a class="hash-link" href="#zero-copy" title="Direct link to heading">​</a></h5><p>区别：</p><p><img alt="img" src="/assets/images/beb09748d5824fa025c5eb30146ffa34-6c73d346e16ef2546d86d4a278b47a50.png" width="672" height="363"></p><p><img alt="img" src="/assets/images/7f217c5bf9bd4787619b7b4861ca6bda-8234c48a15ca24bfbd7a7ad0edf5124f.png" width="680" height="363"></p><h5 class="anchor anchorWithStickyNavbar_mojV" id="boundary">boundary<a class="hash-link" href="#boundary" title="Direct link to heading">​</a></h5><p>Lower boundary: Only return results once you have at least 10K bytes to send me</p><p>Upper boundary: Chunk</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="partition-allocation">Partition Allocation<a class="hash-link" href="#partition-allocation" title="Direct link to heading">​</a></h4><ul><li>在Broker中平均分配</li><li>每个Partition的各个replica在不同broker中</li><li>机柜数据（0.10.0版本之后支持）</li></ul><p><img alt="kdg2 0605" src="/assets/images/kdg2_0605-4b007b734117460cbe0e4547deb036c6.png" width="600" height="441"></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="file">File<a class="hash-link" href="#file" title="Direct link to heading">​</a></h4><p>分段，比如1G或者一周的数据</p><p>删除时不能删除active segment</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="indexes">Indexes<a class="hash-link" href="#indexes" title="Direct link to heading">​</a></h5><p>每个partition都有一个index，对offset和文件位置作映射</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="compact">Compact<a class="hash-link" href="#compact" title="Direct link to heading">​</a></h5><p><img alt="kdg2 0607" src="/assets/images/kdg2_0607-06a8f0f701e39e7fe377017b54c965d9.png" width="549" height="456"></p><h5 class="anchor anchorWithStickyNavbar_mojV" id="producers-retry">Producers Retry<a class="hash-link" href="#producers-retry" title="Direct link to heading">​</a></h5><p>message will be stored at least once, but not exactly once.</p><p>当然，也可以配置enable.idempotence，让broker跳过重复的消息。</p><p>Producer需要能够handle Non-retriable errors</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="consumer">Consumer<a class="hash-link" href="#consumer" title="Direct link to heading">​</a></h5><p>从Partition fetch一个batch，检查最后的offset，然后发出新的request 从最后的offset开始申请batch。</p><p>由于consumer可能会出错，或者停止，需要有一种手段来恢复到上一次consume的offset。这就需要consumer去commit offset。</p><p>对于每一个Partition，consumer都会存储当前的位置。当consumer确认收到并且处理完message后，才会向kafka commit offset。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="writing">Writing<a class="hash-link" href="#writing" title="Direct link to heading">​</a></h3><p><img alt="kdg2 0301" src="/assets/images/kdg2_0301-6270ff81e68f0b68296c40adfdf6a474.png" width="600" height="625"></p><h5 class="anchor anchorWithStickyNavbar_mojV" id="timing配置">timing配置<a class="hash-link" href="#timing配置" title="Direct link to heading">​</a></h5><p><img alt="kdg2 0302" src="/assets/images/kdg2_0302-b1d904a8bb642c9846a15487f3be3846.png" width="600" height="241"></p><h5 class="anchor anchorWithStickyNavbar_mojV" id="maxblockms">max.block.ms<a class="hash-link" href="#maxblockms" title="Direct link to heading">​</a></h5><p>producer调用send()之后，由于send buffer满了，或者metadata取不到，这时设置一个超时抛异常。</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="deliverytimeoutms">delivery.timeout.ms<a class="hash-link" href="#deliverytimeoutms" title="Direct link to heading">​</a></h4><h5 class="anchor anchorWithStickyNavbar_mojV" id="requesttimeoutms">request.timeout.ms<a class="hash-link" href="#requesttimeoutms" title="Direct link to heading">​</a></h5><p>这个很好理解，就是请求发出去了但是server无应答，超时抛异常。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="retrybackoffms">retry.backoff.ms<a class="hash-link" href="#retrybackoffms" title="Direct link to heading">​</a></h5><p>默认每隔100ms进行一次retry，但是通过这个参数可以进行调整。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="lingerms">linger.ms<a class="hash-link" href="#lingerms" title="Direct link to heading">​</a></h5><p>producer会在两种情况下发送batch：</p><ul><li><p>batch已经写满了消息</p></li><li><p>消息没写满，但是达到了linger.ms设置的等待时长</p></li></ul><h5 class="anchor anchorWithStickyNavbar_mojV" id="batchsize">batch.size<a class="hash-link" href="#batchsize" title="Direct link to heading">​</a></h5><p>Batch在内存中的字节长度</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="maxinflightrequestsperconnection">max.in.flight.requests.per.connection<a class="hash-link" href="#maxinflightrequestsperconnection" title="Direct link to heading">​</a></h5><p>在未收到response的情况下，最多发多少个请求。这个参数可以控制吞吐量，默认是5</p><p>in flight request如果大于1，那么有可能出现第一个batch失败，第二个成功的情况。</p><p>对于一些比如银行等业务，这个是不可接受的。但是小于2又会有性能问题。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="enableidempotencetrue">enable.idempotence=true<a class="hash-link" href="#enableidempotencetrue" title="Direct link to heading">​</a></h5><p>message ordering &lt;= 5时能够保证消息的顺序。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="quotas">Quotas<a class="hash-link" href="#quotas" title="Direct link to heading">​</a></h5><h5 class="anchor anchorWithStickyNavbar_mojV" id="quotaproducerdefault2m">quota.producer.default=2M<a class="hash-link" href="#quotaproducerdefault2m" title="Direct link to heading">​</a></h5><p>设置producer/consumer/request的 rate limit</p><p>但这个选项可能会导致消息囤积在producer的缓冲区，导致存储溢出</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="reading">Reading<a class="hash-link" href="#reading" title="Direct link to heading">​</a></h3><p><img alt="kdg2 0401" src="/assets/images/kdg2_0401-3458f79a2c9dde22318fcb1b5872c771.png" width="600" height="414"></p><p>如果一个Consumer group里只有一个consumer，它会接收到所有Partition的消息。</p><p>如果一个Consumer group里的consumer数量大于partition数量，有的consumer就接收不到消息了。</p><p><img alt="kdg2 0404" src="/assets/images/kdg2_0404-982fdc03ee2e6e5fc4020627e3c42e42.png" width="600" height="492"></p><p>如果存在多个Consumer group，多个group之间是互相独立的。</p><p><img alt="kdg2 0405" src="/assets/images/kdg2_0405-d98482b89964f525a4efeac88e165bd5.png" width="600" height="703"></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="rebalance">Rebalance<a class="hash-link" href="#rebalance" title="Direct link to heading">​</a></h4><p>将partition的ownership从一个consumer转移到另一个consumer，称为rebalance.</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="eager-rebalance">Eager rebalance<a class="hash-link" href="#eager-rebalance" title="Direct link to heading">​</a></h5><p><img alt="kdg2 0406" src="/assets/images/kdg2_0406-d33991e55a8e7587cc1743c9e2fd3a67.png" width="600" height="245"></p><p>所有consumer暂停消费消息，放弃ownership，重新加入consumer group，等待broker重新分配ownership。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="cooperative-rebalanceincremental-rebalance">Cooperative rebalance(incremental rebalance)<a class="hash-link" href="#cooperative-rebalanceincremental-rebalance" title="Direct link to heading">​</a></h5><p>Consumer group leader会通知其他consumer，哪些partition会被重新安排。own这些Partiton的consumer会停止消费这些partition的消息，然后consumer group leader将这些partition重新分配给目标consumer。</p><p><img alt="kdg2 0407" src="/assets/images/kdg2_0407-ce045ddddf0153f0facd06a70dc6f53f.png" width="600" height="256"></p><p>通过发送心跳包来确认consumer在线。</p><p>第一个加入Consumer group的成为group leader。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="static-group-membership">Static group membership<a class="hash-link" href="#static-group-membership" title="Direct link to heading">​</a></h5><p>consumer也可以配置为静态的成员，这样当consumer断开连接后，它的partition不会被rearrange，而是等待它上线后恢复消费。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="maxpollintervalms">max.poll.interval.ms<a class="hash-link" href="#maxpollintervalms" title="Direct link to heading">​</a></h5><p>尽管kafka通过background thread心跳包来确认consumer是否在线，但是在线并不代表它能够正常处理消息。</p><p>可以通过这个值来控制，如果client超过这个时间还没有发送第二次poll()，那么认为它的线程已经dead了。</p><p>默认是5分钟</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="autooffsetreset">auto.offset.reset<a class="hash-link" href="#autooffsetreset" title="Direct link to heading">​</a></h5><p>有latest和earliest两种，控制没有offset时是读取最新消息还是全量消息。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="partitionassignmentstrategy">partition.assignment.strategy<a class="hash-link" href="#partitionassignmentstrategy" title="Direct link to heading">​</a></h5><p><em>Range</em></p><p>partition除以consumer count后，得到连续的编号范围，分配给consumer。</p><p><em>RoundRobin</em></p><p>把所有的partition one-by-one分配给consumers</p><p><em>Sticky</em></p><p>比RoundRobin更加平衡，在Reassign的时候减少了Rebalance的次数</p><p><em>Cooperative Sticky</em></p><p>支持Cooperative Rebalance</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="offsetsretentionminutes">offsets.retention.minutes<a class="hash-link" href="#offsetsretentionminutes" title="Direct link to heading">​</a></h5><p>Group里的消息被消费完了，默认保留7天，然后offset会清零，consumer group会和新加入的一样。</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="offsets">Offsets<a class="hash-link" href="#offsets" title="Direct link to heading">​</a></h4><p><img alt="kdg2 0408" src="/assets/images/kdg2_0408-2fc3ff5c547d978a086f2f994cee04cc.png" width="600" height="257"></p><p>如上图，最坏的情况：如果BatchSize=5，上一个Batch处理完了，收到下一个Batch。但是Commit Offset=7没有发出去，然后处理到10的时候consumer挂了。这个时候，下一个接替的consumer会从2开始处理，导致从3~10这几个都被重复处理了。</p><p>解决办法就是manual commit offset，调用API处理完一条消息后就commit。</p><p>commitAsync没有retry，commitSync有retry。</p><p>当然，增加Specified commit会减少出错时重复处理的消息数量，但也会降低Throughput。</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="atomic-multipartition-writes">atomic multipartition writes<a class="hash-link" href="#atomic-multipartition-writes" title="Direct link to heading">​</a></h4><p><img alt="kdg2 0801" src="/assets/images/kdg2_0801-cfdde2cce5f37db927f4712a4f3c05ad.png" width="600" height="235"></p><p>Consume，Process，Produce三步形成一个原子操作，就是让Produce时同时更新数据和Offset，要么都无法更新要么都可以更新。</p><p><img alt="kdg2 0802" src="/assets/images/kdg2_0802-10207f5fc204b9d2f008c62a420cfb41.png" width="600" height="315"></p><p>Last Stable Offset, or LSO</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="安装">安装<a class="hash-link" href="#安装" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_mojV" id="mac">Mac<a class="hash-link" href="#mac" title="Direct link to heading">​</a></h4><p>安装openjdk</p><p><code>brew install openjdk</code></p><p>然后开启zookeeper</p><p><code>zookeeper-server-start /opt/homebrew/Cellar/kafka/3.2.0/libexec/config/zookeeper.properties</code></p><p>开启kafka</p><p>Enable JMX</p><p><a href="https://docs.microfocus.com/doc/MP_for_Apache_Kafka/1.10/Kafka/Kafka_JMX" target="_blank" rel="noopener noreferrer">ITOM Practitioner Portal (microfocus.com)</a></p><p><code>env JMX_PORT=&lt;portnumber&gt; kafka-server-start /opt/homebrew/Cellar/kafka/3.2.0/libexec/config/server.properties</code></p><p>创建topic</p><p><code>kafka-topics --bootstrap-server localhost:9092 --create --replication-factor 1 --partitions 1 --topic test</code></p><p>输出：
Created topic test.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">(base) ➜  ~ kafka-topics --bootstrap-server localhost:9092 --describe --topic test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Topic: test TopicId: cqJ9A01WRpOhwcD1sBLKTA PartitionCount: 1   ReplicationFactor: 1    Configs: segment.bytes=1073741824</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Topic: test Partition: 0    Leader: 0   Replicas: 0 Isr: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(base) ➜  ~</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>测试Consumer 和 Producer</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">(base) ➜  ~ kafka-console-producer --bootstrap-server localhost:9092 --topic test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt;Hello Kafka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt;Bye</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt;^C%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(base) ➜  ~ kafka-console-consumer --bootstrap-server localhost:9092 --topic test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">^CProcessed a total of 0 messages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(base) ➜  ~ kafka-console-consumer --bootstrap-server localhost:9092 --topic test --from-beginning</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hello Kafka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Bye</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">^CProcessed a total of 2 messages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(base) ➜  ~ kafka-console-consumer --bootstrap-server localhost:9092 --topic test --from-beginning</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hello Kafka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Bye</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">^CProcessed a total of 2 messages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(base) ➜  ~</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>这里可以用zkcli看到，kafka已经在更新zookeeper的状态：</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">[zk: localhost:2181(CONNECTED) 2] ls /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[admin, brokers, cluster, config, consumers, controller, controller_epoch, feature, isr_change_notification, latest_producer_id_block, log_dir_event_notification, zookeeper]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[zk: localhost:2181(CONNECTED) 3] ls /brokers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[ids, seqid, topics]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[zk: localhost:2181(CONNECTED) 4] ls /brokers/topics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[__consumer_offsets, test]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[zk: localhost:2181(CONNECTED) 5] ls /brokers/topics/test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[partitions]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[zk: localhost:2181(CONNECTED) 6] ls /brokers/topics/test/partitions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[zk: localhost:2181(CONNECTED) 7] ls /brokers/topics/test/partitions/0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[state]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[zk: localhost:2181(CONNECTED) 8] ls /brokers/topics/test/partitions/0/state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[zk: localhost:2181(CONNECTED) 9] ls /brokers/topics/__consumer_offsets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[partitions]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[zk: localhost:2181(CONNECTED) 10] ls /brokers/topics/__consumer_offsets/partitions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[0, 1, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 2, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 3, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 4, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 5, 6, 7, 8, 9]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>我们可以用cmak工具来看：</p><p><a href="https://github.com/yahoo/CMAK" target="_blank" rel="noopener noreferrer">https://github.com/yahoo/CMAK</a></p><p>下载下来后，修改application.conf文件</p><p><code>cmak.zkhosts=&quot;0.0.0.0:2181&quot;</code></p><p>然后启动，注意不要用jdk16以上的版本，加载css会报错，应该是个bug</p><p><code>bin/cmak -java-home /opt/homebrew/opt/openjdk@11/</code></p><p>然后访问localhost:9000</p><p>添加cluster, zk 设置为localhost:9000</p><p>可以看到topics，brokers</p><p>点进topics</p><p><img alt="image-20220821104616084" src="/assets/images/image-20220821104616084-2bafbc84af13313c17433cf7c5548d93.png" width="2538" height="1318"></p><p>如果enable了JMX，我们就可以看到metrics了。</p><p>比如起一个console,作为consumer，一个作为producer</p><p><code>➜  ~ kafka-console-consumer --bootstrap-server localhost:9092 --topic test</code></p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">~ kafka-console-producer --bootstrap-server localhost:9092 --topic test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt;hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt;i&#x27;m fine</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>发现consumer那边收到了消息：</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">➜  ~ kafka-console-consumer --bootstrap-server localhost:9092 --topic test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">i&#x27;m fine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>然后回到CMAK，刷新，发现metrics有变化</p><p><img alt="image-20220821110425179" src="/assets/images/image-20220821110425179-a06ac1f9c1ff900af8d8bfe54ea0af34.png" width="974" height="828"></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/big-data/kafka.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/big-data/hadoop"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">hadoop</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/cryptography/overview"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">overview</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#kafka简介" class="table-of-contents__link toc-highlight">kafka简介</a></li><li><a href="#zookeeper" class="table-of-contents__link toc-highlight">Zookeeper</a></li><li><a href="#writing" class="table-of-contents__link toc-highlight">Writing</a></li><li><a href="#reading" class="table-of-contents__link toc-highlight">Reading</a></li><li><a href="#安装" class="table-of-contents__link toc-highlight">安装</a></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.fb9af459.js"></script>
<script src="/assets/js/main.47f840b1.js"></script>
</body>
</html>