"use strict";(self.webpackChunkhyc_3z_website=self.webpackChunkhyc_3z_website||[]).push([[72],{3905:function(e,t,l){l.d(t,{Zo:function(){return p},kt:function(){return k}});var a=l(7294);function r(e,t,l){return t in e?Object.defineProperty(e,t,{value:l,enumerable:!0,configurable:!0,writable:!0}):e[t]=l,e}function n(e,t){var l=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),l.push.apply(l,a)}return l}function o(e){for(var t=1;t<arguments.length;t++){var l=null!=arguments[t]?arguments[t]:{};t%2?n(Object(l),!0).forEach((function(t){r(e,t,l[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(l)):n(Object(l)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(l,t))}))}return e}function i(e,t){if(null==e)return{};var l,a,r=function(e,t){if(null==e)return{};var l,a,r={},n=Object.keys(e);for(a=0;a<n.length;a++)l=n[a],t.indexOf(l)>=0||(r[l]=e[l]);return r}(e,t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);for(a=0;a<n.length;a++)l=n[a],t.indexOf(l)>=0||Object.prototype.propertyIsEnumerable.call(e,l)&&(r[l]=e[l])}return r}var s=a.createContext({}),c=function(e){var t=a.useContext(s),l=t;return e&&(l="function"==typeof e?e(t):o(o({},t),e)),l},p=function(e){var t=c(e.components);return a.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var l=e.components,r=e.mdxType,n=e.originalType,s=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),d=c(l),k=r,m=d["".concat(s,".").concat(k)]||d[k]||u[k]||n;return l?a.createElement(m,o(o({ref:t},p),{},{components:l})):a.createElement(m,o({ref:t},p))}));function k(e,t){var l=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var n=l.length,o=new Array(n);o[0]=d;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i.mdxType="string"==typeof e?e:r,o[1]=i;for(var c=2;c<n;c++)o[c]=l[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,l)}d.displayName="MDXCreateElement"},2957:function(e,t,l){l.r(t),l.d(t,{frontMatter:function(){return i},contentTitle:function(){return s},metadata:function(){return c},toc:function(){return p},default:function(){return d}});var a=l(7462),r=l(3366),n=(l(7294),l(3905)),o=["components"],i={title:"Kafka & Zookeeper \u57fa\u7840\u77e5\u8bc6"},s=void 0,c={unversionedId:"big-data/kafka",id:"big-data/kafka",title:"Kafka & Zookeeper \u57fa\u7840\u77e5\u8bc6",description:"kafka\u7b80\u4ecb",source:"@site/docs/big-data/kafka.md",sourceDirName:"big-data",slug:"/big-data/kafka",permalink:"/docs/intro/docs/big-data/kafka",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/big-data/kafka.md",tags:[],version:"current",frontMatter:{title:"Kafka & Zookeeper \u57fa\u7840\u77e5\u8bc6"},sidebar:"tutorialSidebar",previous:{title:"Hadoop \u57fa\u7840\u77e5\u8bc6",permalink:"/docs/intro/docs/big-data/hadoop"},next:{title:"Spark \u57fa\u7840\u77e5\u8bc6",permalink:"/docs/intro/docs/big-data/spark"}},p=[{value:"kafka\u7b80\u4ecb",id:"kafka\u7b80\u4ecb",children:[{value:"Schema",id:"schema",children:[],level:4},{value:"Stream",id:"stream",children:[],level:4},{value:"Producer Consumer",id:"producer-consumer",children:[{value:"Offset",id:"offset",children:[],level:5},{value:"Consumer group",id:"consumer-group",children:[],level:5}],level:4},{value:"Brokers and Clusters",id:"brokers-and-clusters",children:[{value:"MirrorMaker",id:"mirrormaker",children:[],level:5}],level:4},{value:"\u4f18\u52bf",id:"\u4f18\u52bf",children:[],level:4},{value:"\u751f\u6001",id:"\u751f\u6001",children:[],level:4}],level:3},{value:"Zookeeper",id:"zookeeper",children:[{value:"\u6d88\u606f\u961f\u5217\u7684\u6311\u6218",id:"\u6d88\u606f\u961f\u5217\u7684\u6311\u6218",children:[{value:"\u6d88\u606f\u5ef6\u8fdf",id:"\u6d88\u606f\u5ef6\u8fdf",children:[],level:5},{value:"\u5904\u7406\u901f\u5ea6",id:"\u5904\u7406\u901f\u5ea6",children:[],level:5},{value:"\u65f6\u949f\u5bf9\u9f50",id:"\u65f6\u949f\u5bf9\u9f50",children:[],level:5}],level:4},{value:"\u4e3b\u4ece\u7ed3\u6784",id:"\u4e3b\u4ece\u7ed3\u6784",children:[{value:"\u4e3b\u8282\u70b9crash",id:"\u4e3b\u8282\u70b9crash",children:[],level:5},{value:"Worker crash",id:"worker-crash",children:[],level:5},{value:"\u901a\u8baf\u6545\u969c",id:"\u901a\u8baf\u6545\u969c",children:[],level:5}],level:4},{value:"\u5177\u4f53\u529f\u80fd",id:"\u5177\u4f53\u529f\u80fd",children:[{value:"Master election",id:"master-election",children:[],level:5},{value:"Crash detection",id:"crash-detection",children:[],level:5},{value:"Group membership management",id:"group-membership-management",children:[],level:5},{value:"Metadata management",id:"metadata-management",children:[],level:5},{value:"Fischer, Lynch, and Patterson FLP",id:"fischer-lynch-and-patterson-flp",children:[],level:5}],level:4},{value:"ZNode tree",id:"znode-tree",children:[{value:"\u4e8b\u7269\u539f\u5b50\u6027",id:"\u4e8b\u7269\u539f\u5b50\u6027",children:[],level:5},{value:"Polling vs Notification",id:"polling-vs-notification",children:[],level:5},{value:"Version Number",id:"version-number",children:[],level:5}],level:4},{value:"\u4e0eApplication \u4ea4\u4e92",id:"\u4e0eapplication-\u4ea4\u4e92",children:[],level:4},{value:"Leader Election",id:"leader-election",children:[],level:4},{value:"<em>Zab</em>: the ZooKeeper Atomic Broadcast protocol",id:"zab-the-zookeeper-atomic-broadcast-protocol",children:[{value:"Observers",id:"observers",children:[],level:5}],level:4},{value:"Controller",id:"controller",children:[],level:4},{value:"KRaft",id:"kraft",children:[],level:4},{value:"Partition Replicas",id:"partition-replicas",children:[],level:4},{value:"Requests",id:"requests",children:[],level:4},{value:"Produce request",id:"produce-request",children:[],level:4},{value:"Fetch request",id:"fetch-request",children:[{value:"zero-copy",id:"zero-copy",children:[],level:5},{value:"boundary",id:"boundary",children:[],level:5}],level:4},{value:"Partition Allocation",id:"partition-allocation",children:[],level:4},{value:"File",id:"file",children:[{value:"Indexes",id:"indexes",children:[],level:5},{value:"Compact",id:"compact",children:[],level:5},{value:"Producers Retry",id:"producers-retry",children:[],level:5},{value:"Consumer",id:"consumer",children:[],level:5}],level:4}],level:3},{value:"Writing",id:"writing",children:[{value:"timing\u914d\u7f6e",id:"timing\u914d\u7f6e",children:[],level:5},{value:"max.block.ms",id:"maxblockms",children:[],level:5},{value:"delivery.timeout.ms",id:"deliverytimeoutms",children:[{value:"request.timeout.ms",id:"requesttimeoutms",children:[],level:5},{value:"retry.backoff.ms",id:"retrybackoffms",children:[],level:5},{value:"linger.ms",id:"lingerms",children:[],level:5},{value:"batch.size",id:"batchsize",children:[],level:5},{value:"max.in.flight.requests.per.connection",id:"maxinflightrequestsperconnection",children:[],level:5},{value:"enable.idempotence=true",id:"enableidempotencetrue",children:[],level:5},{value:"Quotas",id:"quotas",children:[],level:5},{value:"quota.producer.default=2M",id:"quotaproducerdefault2m",children:[],level:5}],level:4}],level:3},{value:"Reading",id:"reading",children:[{value:"Rebalance",id:"rebalance",children:[{value:"Eager rebalance",id:"eager-rebalance",children:[],level:5},{value:"Cooperative rebalance(incremental rebalance)",id:"cooperative-rebalanceincremental-rebalance",children:[],level:5},{value:"Static group membership",id:"static-group-membership",children:[],level:5},{value:"max.poll.interval.ms",id:"maxpollintervalms",children:[],level:5},{value:"auto.offset.reset",id:"autooffsetreset",children:[],level:5},{value:"partition.assignment.strategy",id:"partitionassignmentstrategy",children:[],level:5},{value:"offsets.retention.minutes",id:"offsetsretentionminutes",children:[],level:5}],level:4},{value:"Offsets",id:"offsets",children:[],level:4},{value:"atomic multipartition writes",id:"atomic-multipartition-writes",children:[],level:4}],level:3},{value:"\u5b89\u88c5",id:"\u5b89\u88c5",children:[{value:"Mac",id:"mac",children:[],level:4}],level:3}],u={toc:p};function d(e){var t=e.components,i=(0,r.Z)(e,o);return(0,n.kt)("wrapper",(0,a.Z)({},u,i,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("h3",{id:"kafka\u7b80\u4ecb"},(0,n.kt)("a",{parentName:"h3",href:"https://zhuanlan.zhihu.com/p/37405836"},"kafka\u7b80\u4ecb")),(0,n.kt)("p",null,"Kafka\u6700\u65e9\u8bde\u751f\u662f\u4e3a\u4e86\u89e3\u51b3Linkedin\u7684data pipeline\u95ee\u9898\u3002"),(0,n.kt)("p",null,(0,n.kt)("a",{parentName:"p",href:"https://engineering.linkedin.com/distributed-systems/log-what-every-software-engineer-should-know-about-real-time-datas-unifying"},"log")),(0,n.kt)("p",null,"\u6570\u636e\u5904\u7406\u6700\u91cd\u8981\u7684\u662f\u6709\u4e00\u4e2a\u5b8c\u6574\u7684\u6570\u636e\u6d41\uff0c\u800c\u4e0d\u662f\u6570\u636e\u6a21\u578b"),(0,n.kt)("p",null,"\u65e5\u5fd7\u5145\u5f53\u4e86\u4e00\u4e2a\u7f13\u5b58\u4f5c\u7528\uff0c\u4f7f\u5f97\u8bfb\u5199\u53ef\u4ee5\u5f02\u6b65"),(0,n.kt)("p",null,"Data which is collected in batch is naturally processed in batch. When  data is collected continuously, it is naturally processed continuously. "),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"kdg2 0102",src:l(5965).Z,width:"600",height:"202"})),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"kdg2 0103",src:l(4171).Z,width:"600",height:"242"})),(0,n.kt)("p",null,"\u4f7f\u7528Kafka\u7684\u4f18\u52bf\u662f\u663e\u800c\u6613\u89c1\u7684\uff1a\u4e0d\u9700\u8981\u518d\u53bb\u505a\u5404\u79cd\u5404\u6837\u7684routing\u548cwiring\uff0c\u5c31\u80fd\u5c06metrics\u901a\u8fc7\u7edf\u4e00\u7684\u5e73\u53f0\u8fdb\u884c\u7edf\u8ba1\u3001\u5206\u6790\u548c\u5206\u53d1\u3002"),(0,n.kt)("h4",{id:"schema"},"Schema"),(0,n.kt)("p",null,"Kafka\u7684\u6d88\u606f\u90fd\u662f\u5b57\u8282\u6570\u7ec4\uff0c\u4f46\u662f\u4e5f\u662f\u6709\u7ed3\u6784\u5b9a\u4e49\u7684\u3002"),(0,n.kt)("h4",{id:"stream"},"Stream"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"kdg2 0105",src:l(5133).Z,width:"600",height:"202"})),(0,n.kt)("p",null,"Stream\u6307\u7684\u662f\u540c\u4e00\u4e2aTopic\u7684\u6d88\u606f\uff0c\u548cPartition\u7684\u6570\u91cf\u65e0\u5173\u3002\u540c\u4e00\u4e2a\u6d88\u606f\u53ef\u4ee5\u6709\u591a\u4e2aPartition\uff0c\u4e5f\u53ef\u4ee5\u5206\u6563\u5728\u591a\u4e2a\u8282\u70b9\u4e0a\uff0c\u63d0\u5347\u6027\u80fd\u548c\u5197\u4f59\u5ea6\u3002"),(0,n.kt)("h4",{id:"producer-consumer"},"Producer Consumer"),(0,n.kt)("p",null,"Producer\u6307\u7684\u5c31\u662f\u6d88\u606f\u7684\u751f\u4ea7\u8005\uff0c\u901a\u5e38\u4f1a\u5e73\u5747\u5730\u5411\u6bcf\u4e2aPartition\u5206\u644a\u6d88\u606f\u3002\u4f46\u4e5f\u6709\u7279\u6b8a\u60c5\u51b5\uff0c\u751f\u4ea7\u8005\u53ea\u4f1a\u5411\u7279\u5b9a\u7684Partition\u53d1\u9001\u6d88\u606f\u3002"),(0,n.kt)("p",null,"Consumer\u8bfb\u53d6\u6d88\u606f\uff0c\u8ba2\u9605\u4e00\u4e2a\u6216\u591a\u4e2aTopic\uff0c\u6309\u987a\u5e8f\u8bfb\u53d6\u6d88\u606f\u3002"),(0,n.kt)("h5",{id:"offset"},"Offset"),(0,n.kt)("p",null,"Consumer\u548cKafka\u90fd\u4fdd\u7559\u4e86\u4e00\u4e2aOffset\uff0c\u4e00\u4e2a\u4e0d\u5b8c\u5168\u5355\u8c03\u9012\u589e\u7684int\uff0c\u540e\u6765\u7684\u6d88\u606foffset\u66f4\u5927\u3002\u6bcf\u4e2apartition\u7684offset\u90fd\u88ab\u4fdd\u5b58\u7740\uff0c\u8fd9\u6837Consumer\u6682\u505c\u63a5\u53d7\u6d88\u606f\u540e\uff0c\u5c31\u53ef\u4ee5resume\u3002"),(0,n.kt)("h5",{id:"consumer-group"},"Consumer group"),(0,n.kt)("p",null,"\u4e00\u4e2a\u6216\u591a\u4e2aConsumer\u5171\u540c\u6d88\u8d39\u540c\u4e00\u4e2atopic\u3002Consumer group\u786e\u4fdd\u6bcf\u4e2apartition\u53ea\u4f1a\u88ab\u4e00\u4e2amember\u6d88\u8d39\u3002\u8fd9\u4e5f\u88ab\u79f0\u4e3aOwnership\u3002"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"kdg2 0106",src:l(2725).Z,width:"600",height:"246"})),(0,n.kt)("p",null,"\u5982\u679c\u4e00\u4e2amember fail\u4e86\uff0c\u90a3\u4e2apartition\u4f1a\u88ab\u91cd\u65b0\u5206\u914d\u5230\u5269\u4f59\u7684members\u4e2d\u3002"),(0,n.kt)("h4",{id:"brokers-and-clusters"},"Brokers and Clusters"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"kdg2 0107",src:l(4592).Z,width:"600",height:"359"})),(0,n.kt)("p",null,"Broker\u4eceproducer\u63a5\u53d7\u6d88\u606f\uff0c\u8bbe\u7f6eoffset\uff0c\u7136\u540e\u5199\u5165\u5b58\u50a8\u3002\u6d88\u606f\u6709\u4e3b\u4ece\u540c\u6b65\u3002"),(0,n.kt)("p",null,"\u6d88\u606f\u6709\u5b58\u50a8\u9650\u5236\u548c\u65f6\u957f\u9650\u5236\uff0c\u8d85\u51fa\u4e86\u5c31\u4f1a\u88ab\u5220\u6389\u3002"),(0,n.kt)("h5",{id:"mirrormaker"},"MirrorMaker"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"kdg2 0108",src:l(5237).Z,width:"600",height:"419"})),(0,n.kt)("p",null,"\u707e\u5907\u7684MirrorMaker\u672c\u8eab\u5c31\u662f\u4e00\u4e2aconsumer\u548cproducer\uff0cconsume\u5176\u4ed6\u96c6\u7fa4\u7684\u6d88\u606f\u7136\u540eproduce\u5230\u672c\u5730\u96c6\u7fa4\u3002"),(0,n.kt)("h4",{id:"\u4f18\u52bf"},"\u4f18\u52bf"),(0,n.kt)("p",null,"\u591aProducer\uff0c\u591aConsumer\uff0c\u672c\u5730\u7559\u5b58\u3002"),(0,n.kt)("p",null,"\u9ad8\u6027\u80fd\uff0c\u9ad8\u53ef\u7528"),(0,n.kt)("h4",{id:"\u751f\u6001"},"\u751f\u6001"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"kdg2 0109",src:l(6455).Z,width:"600",height:"454"})),(0,n.kt)("h3",{id:"zookeeper"},"Zookeeper"),(0,n.kt)("h4",{id:"\u6d88\u606f\u961f\u5217\u7684\u6311\u6218"},"\u6d88\u606f\u961f\u5217\u7684\u6311\u6218"),(0,n.kt)("h5",{id:"\u6d88\u606f\u5ef6\u8fdf"},"\u6d88\u606f\u5ef6\u8fdf"),(0,n.kt)("p",null,"\u200b\tP\u6bd4Q\u5148\u53d1\u9001\u6d88\u606f\uff0c\u4f46Q\u7684\u6d88\u606f\u5148\u5230"),(0,n.kt)("h5",{id:"\u5904\u7406\u901f\u5ea6"},"\u5904\u7406\u901f\u5ea6"),(0,n.kt)("p",null,"\u200b\tT~ps~ + T~s~ + T~pr~ \u65f6\u5ef6 = \u53d1\u9001+\u4f20\u8f93+\u63a5\u53d7"),(0,n.kt)("h5",{id:"\u65f6\u949f\u5bf9\u9f50"},"\u65f6\u949f\u5bf9\u9f50"),(0,n.kt)("p",null,"\u200b\t\u5904\u7406\u5668\u65f6\u949f\u6709\u53ef\u80fd\u4e0d\u51c6\uff0c\u6216\u8005\u672a\u5bf9\u9f50"),(0,n.kt)("p",null,"\u200b\t"),(0,n.kt)("p",null,"\u200b\t\u6d88\u606f\u6ca1\u6536\u5230\uff0c\u6709\u53ef\u80fd\u662f\u4e09\u79cd\u60c5\u51b5\u7684\u4efb\u610f\u4e00\u79cd"),(0,n.kt)("p",null,"\u200b\t"),(0,n.kt)("h4",{id:"\u4e3b\u4ece\u7ed3\u6784"},"\u4e3b\u4ece\u7ed3\u6784"),(0,n.kt)("h5",{id:"\u4e3b\u8282\u70b9crash"},"\u4e3b\u8282\u70b9crash"),(0,n.kt)("p",null,"\u200b\t\u9700\u8981\u5907\u7528Master\uff0c\u65b0\u7684Master\u80fd\u591f\u4ececrash\u65f6\u7684\u72b6\u6001\u6062\u590d\u3002\u6b64\u65f6\uff0c\u6211\u4eec\u4e0d\u80fd\u6307\u671b\u4ececrash\u6389\u7684master\u90a3\u91cc\u8bfb\u53d6\u6062\u590d\u65f6\u7684context\uff0c\u6240\u4ee5\u9700\u8981\u628a\u6570\u636e\u5b58\u5728\u522b\u7684\u5730\u65b9\uff0c\u5c31\u662fzookeeper\u91cc\u3002"),(0,n.kt)("p",null,"\u200b\t",(0,n.kt)("em",{parentName:"p"},"split-brain")," \u4e00\u4e2a\u7cfb\u7edf\u4e2d\u4e24\u4e2a\u6216\u591a\u4e2a\u90e8\u5206\u72ec\u7acb\u5730\u5b8c\u6210\u5de5\u4f5c\uff0c\u6bd4\u5982master\u5b9e\u9645\u5728\u5de5\u4f5c\uff0c\u4f46\u7531\u4e8e\u7f51\u7edc\u6545\u969c\uff0c\u96c6\u7fa4\u88ab\u5212\u5206\u4e3a\u4e86\u4e24\u534a\u3002"),(0,n.kt)("h5",{id:"worker-crash"},"Worker crash"),(0,n.kt)("p",null,"\u200b\t\u91cd\u65b0\u5206\u914d\u8c03\u5ea6\u7ed9Worker\u7684\u4efb\u52a1\u3002\u4efb\u52a1\u53ef\u80fd\u6267\u884c\u4e86\u4e00\u534a\uff0c\u4e5f\u53ef\u80fd\u5df2\u7ecf\u5b8c\u6210\u4f46\u65e0\u6cd5\u6c47\u62a5\u7ed3\u679c\u3002\u5982\u679c\u6709Side effect\uff0c\u90a3\u4e48\u8fd8\u9700\u8981\u6e05\u7406\u72b6\u6001\u3002"),(0,n.kt)("h5",{id:"\u901a\u8baf\u6545\u969c"},"\u901a\u8baf\u6545\u969c"),(0,n.kt)("p",null,"\u200b\t\u9501\u4e0d\u80fd\u89e3\u51b3\u95ee\u9898"),(0,n.kt)("h4",{id:"\u5177\u4f53\u529f\u80fd"},"\u5177\u4f53\u529f\u80fd"),(0,n.kt)("h5",{id:"master-election"},"Master election"),(0,n.kt)("p",null,"\u200b\t\u62e5\u6709master\u624d\u5177\u6709\u5206\u914d\u4efb\u52a1\u7684\u529f\u80fd\uff0c\u6240\u4ee5\u5fc5\u987b\u80fd\u591f\u9009\u4e3e"),(0,n.kt)("h5",{id:"crash-detection"},"Crash detection"),(0,n.kt)("p",null,"\u200b\tMaster\u80fd\u591f\u68c0\u6d4b\u5230worker crash"),(0,n.kt)("h5",{id:"group-membership-management"},"Group membership management"),(0,n.kt)("p",null,"\u200b\tMaster\u80fd\u591f\u5f97\u77e5\u54ea\u4e9b\u8282\u70b9\u80fd\u591f\u6267\u884c\u4efb\u52a1"),(0,n.kt)("h5",{id:"metadata-management"},"Metadata management"),(0,n.kt)("p",null,"\u200b\t\u4e3b\u8282\u70b9\u548c\u4ece\u8282\u70b9\u90fd\u80fd\u591f\u5b58\u50a8\u5206\u914d\u548c\u6267\u884c\u72b6\u6001"),(0,n.kt)("p",null,"Zookeeper \u5e76\u4e0d\u662f Byzantine fault tolerant\u7684\uff0c\u56e0\u4e3a\u8fd9\u4f1a\u5927\u5927\u589e\u52a0\u590d\u6742\u6027\u548c\u5f00\u9500\u3002"),(0,n.kt)("h5",{id:"fischer-lynch-and-patterson-flp"},"Fischer, Lynch, and Patterson FLP"),(0,n.kt)("p",null,"\u5f02\u6b65\u901a\u4fe1\uff0c\u5e76\u4e14\u4f1a\u6545\u969c\u7684\u8fdb\u7a0b\uff0c\u5e76\u6ca1\u6709\u529e\u6cd5\u5bf9\u54ea\u60151bit\u7684\u4fe1\u606f\u8fbe\u6210\u5171\u8bc6\u3002"),(0,n.kt)("p",null,"Impossibility of Distributed Consensus with One Faulty Process\uff0c 1983"),(0,n.kt)("h4",{id:"znode-tree"},"ZNode tree"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"ZooKeeper data tree example.",src:l(1079).Z,width:"952",height:"855"})),(0,n.kt)("p",null,"Znode\u7684\u6240\u6709\u4fe1\u606f\u90fd\u88ab\u5b58\u5728\u4e00\u68f5\u6811\u91cc\uff0c\u5305\u62ecMaster\uff0cWorkers\uff0cTasks\u548cAssign\u3002"),(0,n.kt)("p",null,"\u5982\u679c\u6709\u6570\u636e\u7f3a\u5931\uff0c\u5c31\u8bf4\u660e\u6709\u5730\u65b9\u51fa\u9519\u4e86\u3002\u6bd4\u5982Master\u8fd9\u91cc\u7684\u503c\u662f\u7a7a\uff0c\u5c31\u8bf4\u660e\u9700\u8981\u8fdb\u884cLeader election\u3002"),(0,n.kt)("h5",{id:"\u4e8b\u7269\u539f\u5b50\u6027"},"\u4e8b\u7269\u539f\u5b50\u6027"),(0,n.kt)("p",null,"Zookeeper\u6709API\u53ef\u4ee5\u5bf9\u6570\u636e\u8fdb\u884c\u8bfb\u5199\uff0c\u4f46\u8bfb\u6216\u8005\u5199\u64cd\u4f5c\u90fd\u662f\u539f\u5b50\u6027\u7684\u3002"),(0,n.kt)("h5",{id:"polling-vs-notification"},"Polling vs Notification"),(0,n.kt)("p",null,"Polling:"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"Multiple reads to the same znode./img/foo",src:l(55).Z,width:"1475",height:"717"})),(0,n.kt)("p",null,"\u53ef\u4ee5\u770b\u5230\uff0c\u64cd\u4f5c2\u662f\u4e0d\u5fc5\u8981\u7684\u3002"),(0,n.kt)("p",null,"Notification:"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"Using notifications to indicate changes to a znode",src:l(8670).Z,width:"1430",height:"653"})),(0,n.kt)("h5",{id:"version-number"},"Version Number"),(0,n.kt)("p",null,"\u6bcf\u4e2aZnode\u90fd\u6709\u4e00\u4e2a\u7248\u672c\u53f7"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"Using versions to prevent inconsistencies due to concurrent updates",src:l(2865).Z,width:"1557",height:"685"})),(0,n.kt)("h4",{id:"\u4e0eapplication-\u4ea4\u4e92"},"\u4e0eApplication \u4ea4\u4e92"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"ZooKeeper Architecture Overview.",src:l(386).Z,width:"867",height:"803"})),(0,n.kt)("p",null,"Standalone mode\uff1a\u4e00\u4e2aZookeeper server"),(0,n.kt)("p",null,"Quorum mode: \u591a\u4e2aservers\uff0cstates replicate"),(0,n.kt)("p",null,"\u591a\u6570server\u786e\u8ba4\u72b6\u6001\u88ab\u590d\u5236\uff0c\u624d\u80fd\u6210\u529f\u66f4\u65b0\u72b6\u6001\uff0c\u907f\u514dsplit-brain"),(0,n.kt)("h4",{id:"leader-election"},"Leader Election"),(0,n.kt)("p",null,"Looking state\uff0cFollower state \u548c Leader state\u4e09\u79cd\u72b6\u6001"),(0,n.kt)("p",null,"\u53d1\u73b0Leader \u6302\u6389\uff0c\u9a6c\u4e0a\u8fdb\u5165looking state\uff0c\u7136\u540e\u4e92\u76f8\u7ed9\u6bcf\u4e2aresemble \u91cc\u7684server\u53d1\u6d88\u606f\uff0c\u662f\u4e00\u4e2atuple\u5305\u542b\u81ea\u5df1\u7684serverID(sID)\u548c\u4e0a\u4e00\u4e2a\u8bf7\u6c42\u7684transaction ID(zxID)\u3002\u7136\u540e\u5bf9\u6bd4\uff0c\u9009\u51fa\u6700\u65b0\u5904\u7406\u8bf7\u6c42\u7684\u5f53\u9009leader"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"Leader election illustration.",src:l(9703).Z,width:"1272",height:"675"})),(0,n.kt)("p",null,"\u4f46\u662f\u8fd9\u6837\u505a\u662f\u5efa\u7acb\u5728\u9009\u4e3e\u65f6\u7f51\u7edc\u6761\u4ef6\u5f88\u597d\u7684\u60c5\u51b5\u4e0b\u3002"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"Leader election illustration.",src:l(7849).Z,width:"1269",height:"675"})),(0,n.kt)("p",null,"\u5982\u679c\u7f51\u7edc\u6709\u5ef6\u8fdf\uff0c\u5c31\u4f1a\u51fa\u73b0\u8fd9\u6837\u7684\u60c5\u51b5\u3002\u56e0\u6b64\uff0c\u53ef\u4ee5\u52a0\u4e0a\u4e00\u4e2a\u8d85\u65f6\uff0c\u8bbe\u5b9a\u7b49\u5f85\u7684\u6700\u957f\u65f6\u95f4\u3002Fast Election\u5c31\u8bbe\u7f6e\u4e86200ms"),(0,n.kt)("h4",{id:"zab-the-zookeeper-atomic-broadcast-protocol"},(0,n.kt)("em",{parentName:"h4"},"Zab"),": the ZooKeeper Atomic Broadcast protocol"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"\u9996\u5148\uff0cLeader\u4f1a\u5411\u6240\u6709Follower\u53d1\u9001\u4e00\u4e2aProposal \u4fe1\u606f"),(0,n.kt)("li",{parentName:"ul"},"Follower\u5411Leader \u53d1\u9001 ACK"),(0,n.kt)("li",{parentName:"ul"},"Leader \u5411Follower \u53d1\u9001 Commit")),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"Regular message pattern to commit proposals.",src:l(4316).Z,width:"1269",height:"669"})),(0,n.kt)("p",null,"\u8fd9\u6837\u505a\u80fd\u786e\u4fdd\u4e8b\u52a1\u7684\u5904\u7406\u987a\u5e8f\uff0c\u5e76\u4e14\u4e0d\u9057\u6f0f\u4e8b\u52a1\u3002"),(0,n.kt)("p",null,"Epoch\uff1a\u4ee3\u8868Leader\u7684term\uff0c\u6bcf\u6b21leader election\u90fd\u4f1a\u589e\u52a0epoch\uff0c\u6bcf\u6b21transaction\u90fd\u4f1a\u5305\u542bepoch"),(0,n.kt)("p",null,"DIFF\uff1a\u8f6c\u6362Epoch\u65f6\uff0c\u5982\u679c\u76f8\u5dee\u4e0d\u591a\uff0cLeader\u4f1a\u53d1\u9001Follower\u7f3a\u5931\u7684transaction\u3002"),(0,n.kt)("p",null,"SNAP\uff1a\u76f8\u5dee\u5f88\u5927\uff0cLeader\u4f1a\u53d1\u9001\u5168\u91cf\u7684snapshot"),(0,n.kt)("h5",{id:"observers"},"Observers"),(0,n.kt)("p",null,"\u4e0d\u53c2\u4e0e\u6295\u7968\uff0c\u4e0d\u53c2\u4e0eproposal"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"Illustration of the leader server pipeline.",src:l(3451).Z,width:"1531",height:"396"})),(0,n.kt)("p",null,"Master\u5728\u5904\u7406\u5b8cProposal\u540e\uff0c\u4f1a\u540c\u65f6\u5904\u7406Commit\u4ee5\u53ca\u6301\u4e45\u5316\u5230\u672c\u5730"),(0,n.kt)("p",null,"\u56de\u5230Kafka\uff0ckafka\u7684broker\u5c31\u662f\u5728zookeeper\u4e2d\u4ee5",(0,n.kt)("em",{parentName:"p"},"/brokers/ids"),"\u7684\u5f62\u5f0f\u6ce8\u518c\u7684\u3002"),(0,n.kt)("p",null,"\u7531\u4e8eephemeral node\u7684\u7279\u6027\uff0c\u5f53broker\u5931\u8054\u4e86\uff0csession\u65ad\u5f00\uff0c\u5b83\u7684\u8282\u70b9\u5c31\u4f1a\u88abzookeeper\u81ea\u52a8\u79fb\u9664\u3002"),(0,n.kt)("h4",{id:"controller"},"Controller"),(0,n.kt)("p",null,"broker+ partition leader election\uff0c\u6bcf\u4e2acluster\u53ea\u4f1a\u540c\u65f6\u6709\u4e00\u4e2acontroller\u3002"),(0,n.kt)("h4",{id:"kraft"},"KRaft"),(0,n.kt)("p",null,"2019\u5e74\u5f00\u59cb\u7684\u9879\u76ee"),(0,n.kt)("p",null,"\u73b0\u6709\u95ee\u9898\uff1a"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Metadata\u540c\u6b65\u5199\u5165ZooKeeper\uff0c\u5206\u53d1\u7ed9broker\u5374\u662f\u5f02\u6b65\u3002\u56e0\u6b64\u5b58\u5728broker\uff0ccontroller\uff0czookeeper\u4e09\u8005\u72b6\u6001\u4e0d\u4e00\u81f4\u7684\u60c5\u51b5"),(0,n.kt)("li",{parentName:"ul"},"\u5f53controller\u91cd\u542f\u65f6\uff0c\u9700\u8981\u91cd\u65b0\u4ecezookeeper\u8bfb\u5168\u91cf\u7684\u72b6\u6001\u6570\u636e\uff0c\u975e\u5e38\u6162\u3002"),(0,n.kt)("li",{parentName:"ul"},"Ownership\u4e0d\u660e\u786e\uff0c\u540c\u6837\u7684\u6570\u636e\u6709\u4e9b\u662fcontroller\u6539\u7684\uff0c\u6709\u4e9b\u662fbroker\u6539\u7684\uff0c\u6709\u4e9b\u662fzookeeper\u6539\u7684"),(0,n.kt)("li",{parentName:"ul"},"Zookeeper\u672c\u8eab\u4e5f\u662f\u4e00\u4e2a\u5206\u5e03\u5f0f\u7cfb\u7edf")),(0,n.kt)("p",null,"\u89e3\u51b3\u65b9\u6cd5:"),(0,n.kt)("p",null,"KRaft\uff0c\u5c06controller\u5206\u4e3a active controller \u548cfollower controllers\uff0cactive controller\u8d1f\u8d23\u5904\u7406broker\u4e8b\u52a1\u3002"),(0,n.kt)("p",null,"Controller nodes\u81ea\u5df1leader election\uff0c\u539f\u672c\u5b58\u50a8\u5728zookeeper\u7684\u6570\u636e\u5b58\u5728\u4e00\u4e2alog\u4e2d\u3002"),(0,n.kt)("p",null,(0,n.kt)("a",{parentName:"p",href:"https://cwiki.apache.org/confluence/display/KAFKA/KIP-500%3A+Replace+ZooKeeper+with+a+Self-Managed+Metadata+Quorum#KIP500:ReplaceZooKeeperwithaSelfManagedMetadataQuorum-MetadataasanEventLog"},"KIP-500: Replace ZooKeeper with a Self-Managed Metadata Quorum - Apache Kafka - Apache Software Foundation")),(0,n.kt)("p",null,(0,n.kt)("a",{parentName:"p",href:"https://cwiki.apache.org/confluence/display/KAFKA/KIP-595%3A+A+Raft+Protocol+for+the+Metadata+Quorum"},"KIP-595: A Raft Protocol for the Metadata Quorum - Apache Kafka - Apache Software Foundation")),(0,n.kt)("p",null,(0,n.kt)("a",{parentName:"p",href:"https://cwiki.apache.org/confluence/display/KAFKA/KIP-631%3A+The+Quorum-based+Kafka+Controller"},"KIP-631: The Quorum-based Kafka Controller - Apache Kafka - Apache Software Foundation")),(0,n.kt)("h4",{id:"partition-replicas"},"Partition Replicas"),(0,n.kt)("p",null,"\u6bcf\u4e2aTopic \u53ef\u4ee5\u6709\u591a\u4e2aPartition\uff0c\u800c\u6bcf\u4e2aPartition\u53ef\u4ee5\u6709\u591a\u4e2areplica\u3002"),(0,n.kt)("p",null,"Replica\u4e5f\u5206\u4e3b\u4ece\uff0c\u4e3b\u8d1f\u8d23\u5904\u7406client request\uff0c\u4ece\u590d\u5236\u6d88\u606f\u5e76\u4e14\u4f5c\u4e3a\u5907\u4efd\u3002"),(0,n.kt)("p",null,"KIP-392\u4e4b\u540e\uff0cfollower partition\u4e5f\u53ef\u4ee5\u5904\u7406client request\u3002 "),(0,n.kt)("p",null,(0,n.kt)("a",{parentName:"p",href:"https://cwiki.apache.org/confluence/display/KAFKA/KIP-392%3A+Allow+consumers+to+fetch+from+closest+replica"},"KIP-392: Allow consumers to fetch from closest replica - Apache Kafka - Apache Software Foundation")),(0,n.kt)("h4",{id:"requests"},"Requests"),(0,n.kt)("p",null,(0,n.kt)("a",{parentName:"p",href:"https://www.confluent.io/blog/apache-kafka-purgatory-hierarchical-timing-wheels/"},"Apache Kafka, Purgatory, and Hierarchical Timing Wheels | Confluent")),(0,n.kt)("p",null,"Request type (also called API key)"),(0,n.kt)("p",null,"Request version (so the brokers can handle clients of different versions and respond accordingly)"),(0,n.kt)("p",null,"Correlation ID: a number that uniquely identifies the request and also appears in the response and in the error logs (the ID is used for troubleshooting)"),(0,n.kt)("p",null,"Client ID: used to identify the application that sent the request"),(0,n.kt)("p",null,(0,n.kt)("a",{parentName:"p",href:"https://kafka.apache.org/protocol.html"},"Apache Kafka")),(0,n.kt)("p",null,"\u7531\u4e8eClient\u5e76\u4e0d\u77e5\u9053\u8981\u5411\u54ea\u4e2apartition\u53d1\u6d88\u606f\uff0c\u6240\u4ee5\u9700\u8981metadata request\uff0c\u7136\u540ebroker\u8fd4\u56detopic\uff0cpartition\u4ee5\u53caleader\u7684\u4fe1\u606f\u3002"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"kdg2 0602",src:l(4827).Z,width:"600",height:"390"})),(0,n.kt)("h4",{id:"produce-request"},"Produce request"),(0,n.kt)("p",null,"Acks=<0,1,all>"),(0,n.kt)("p",null,"\u4e0d\u7b49\u5f85\uff0c\u53ea\u7b49\u5f85leader\uff0c\u7b49\u5f85\u6240\u6709replica sync"),(0,n.kt)("h4",{id:"fetch-request"},"Fetch request"),(0,n.kt)("h5",{id:"zero-copy"},"zero-copy"),(0,n.kt)("p",null,"\u533a\u522b\uff1a"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"img",src:l(5813).Z,width:"672",height:"363"})),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"img",src:l(4217).Z,width:"680",height:"363"})),(0,n.kt)("h5",{id:"boundary"},"boundary"),(0,n.kt)("p",null,"Lower boundary: Only return results once you have at least 10K bytes to send me"),(0,n.kt)("p",null,"Upper boundary: Chunk"),(0,n.kt)("h4",{id:"partition-allocation"},"Partition Allocation"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"\u5728Broker\u4e2d\u5e73\u5747\u5206\u914d"),(0,n.kt)("li",{parentName:"ul"},"\u6bcf\u4e2aPartition\u7684\u5404\u4e2areplica\u5728\u4e0d\u540cbroker\u4e2d"),(0,n.kt)("li",{parentName:"ul"},"\u673a\u67dc\u6570\u636e\uff080.10.0\u7248\u672c\u4e4b\u540e\u652f\u6301\uff09")),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"kdg2 0605",src:l(9626).Z,width:"600",height:"441"})),(0,n.kt)("h4",{id:"file"},"File"),(0,n.kt)("p",null,"\u5206\u6bb5\uff0c\u6bd4\u59821G\u6216\u8005\u4e00\u5468\u7684\u6570\u636e"),(0,n.kt)("p",null,"\u5220\u9664\u65f6\u4e0d\u80fd\u5220\u9664active segment"),(0,n.kt)("h5",{id:"indexes"},"Indexes"),(0,n.kt)("p",null,"\u6bcf\u4e2apartition\u90fd\u6709\u4e00\u4e2aindex\uff0c\u5bf9offset\u548c\u6587\u4ef6\u4f4d\u7f6e\u4f5c\u6620\u5c04"),(0,n.kt)("h5",{id:"compact"},"Compact"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"kdg2 0607",src:l(8541).Z,width:"549",height:"456"})),(0,n.kt)("h5",{id:"producers-retry"},"Producers Retry"),(0,n.kt)("p",null,"message will be stored at least once, but not exactly once."),(0,n.kt)("p",null,"\u5f53\u7136\uff0c\u4e5f\u53ef\u4ee5\u914d\u7f6eenable.idempotence\uff0c\u8ba9broker\u8df3\u8fc7\u91cd\u590d\u7684\u6d88\u606f\u3002"),(0,n.kt)("p",null,"Producer\u9700\u8981\u80fd\u591fhandle Non-retriable errors"),(0,n.kt)("h5",{id:"consumer"},"Consumer"),(0,n.kt)("p",null,"\u4ecePartition fetch\u4e00\u4e2abatch\uff0c\u68c0\u67e5\u6700\u540e\u7684offset\uff0c\u7136\u540e\u53d1\u51fa\u65b0\u7684request \u4ece\u6700\u540e\u7684offset\u5f00\u59cb\u7533\u8bf7batch\u3002"),(0,n.kt)("p",null,"\u7531\u4e8econsumer\u53ef\u80fd\u4f1a\u51fa\u9519\uff0c\u6216\u8005\u505c\u6b62\uff0c\u9700\u8981\u6709\u4e00\u79cd\u624b\u6bb5\u6765\u6062\u590d\u5230\u4e0a\u4e00\u6b21consume\u7684offset\u3002\u8fd9\u5c31\u9700\u8981consumer\u53bbcommit offset\u3002"),(0,n.kt)("p",null,"\u5bf9\u4e8e\u6bcf\u4e00\u4e2aPartition\uff0cconsumer\u90fd\u4f1a\u5b58\u50a8\u5f53\u524d\u7684\u4f4d\u7f6e\u3002\u5f53consumer\u786e\u8ba4\u6536\u5230\u5e76\u4e14\u5904\u7406\u5b8cmessage\u540e\uff0c\u624d\u4f1a\u5411kafka commit offset\u3002"),(0,n.kt)("h3",{id:"writing"},"Writing"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"kdg2 0301",src:l(5908).Z,width:"600",height:"625"})),(0,n.kt)("h5",{id:"timing\u914d\u7f6e"},"timing\u914d\u7f6e"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"kdg2 0302",src:l(1963).Z,width:"600",height:"241"})),(0,n.kt)("h5",{id:"maxblockms"},"max.block.ms"),(0,n.kt)("p",null,"producer\u8c03\u7528send()\u4e4b\u540e\uff0c\u7531\u4e8esend buffer\u6ee1\u4e86\uff0c\u6216\u8005metadata\u53d6\u4e0d\u5230\uff0c\u8fd9\u65f6\u8bbe\u7f6e\u4e00\u4e2a\u8d85\u65f6\u629b\u5f02\u5e38\u3002"),(0,n.kt)("h4",{id:"deliverytimeoutms"},"delivery.timeout.ms"),(0,n.kt)("h5",{id:"requesttimeoutms"},"request.timeout.ms"),(0,n.kt)("p",null,"\u8fd9\u4e2a\u5f88\u597d\u7406\u89e3\uff0c\u5c31\u662f\u8bf7\u6c42\u53d1\u51fa\u53bb\u4e86\u4f46\u662fserver\u65e0\u5e94\u7b54\uff0c\u8d85\u65f6\u629b\u5f02\u5e38\u3002"),(0,n.kt)("h5",{id:"retrybackoffms"},"retry.backoff.ms"),(0,n.kt)("p",null,"\u9ed8\u8ba4\u6bcf\u9694100ms\u8fdb\u884c\u4e00\u6b21retry\uff0c\u4f46\u662f\u901a\u8fc7\u8fd9\u4e2a\u53c2\u6570\u53ef\u4ee5\u8fdb\u884c\u8c03\u6574\u3002"),(0,n.kt)("h5",{id:"lingerms"},"linger.ms"),(0,n.kt)("p",null,"producer\u4f1a\u5728\u4e24\u79cd\u60c5\u51b5\u4e0b\u53d1\u9001batch\uff1a"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},"batch\u5df2\u7ecf\u5199\u6ee1\u4e86\u6d88\u606f")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},"\u6d88\u606f\u6ca1\u5199\u6ee1\uff0c\u4f46\u662f\u8fbe\u5230\u4e86linger.ms\u8bbe\u7f6e\u7684\u7b49\u5f85\u65f6\u957f"))),(0,n.kt)("h5",{id:"batchsize"},"batch.size"),(0,n.kt)("p",null,"Batch\u5728\u5185\u5b58\u4e2d\u7684\u5b57\u8282\u957f\u5ea6"),(0,n.kt)("h5",{id:"maxinflightrequestsperconnection"},"max.in.flight.requests.per.connection"),(0,n.kt)("p",null,"\u5728\u672a\u6536\u5230response\u7684\u60c5\u51b5\u4e0b\uff0c\u6700\u591a\u53d1\u591a\u5c11\u4e2a\u8bf7\u6c42\u3002\u8fd9\u4e2a\u53c2\u6570\u53ef\u4ee5\u63a7\u5236\u541e\u5410\u91cf\uff0c\u9ed8\u8ba4\u662f5"),(0,n.kt)("p",null,"in flight request\u5982\u679c\u5927\u4e8e1\uff0c\u90a3\u4e48\u6709\u53ef\u80fd\u51fa\u73b0\u7b2c\u4e00\u4e2abatch\u5931\u8d25\uff0c\u7b2c\u4e8c\u4e2a\u6210\u529f\u7684\u60c5\u51b5\u3002"),(0,n.kt)("p",null,"\u5bf9\u4e8e\u4e00\u4e9b\u6bd4\u5982\u94f6\u884c\u7b49\u4e1a\u52a1\uff0c\u8fd9\u4e2a\u662f\u4e0d\u53ef\u63a5\u53d7\u7684\u3002\u4f46\u662f\u5c0f\u4e8e2\u53c8\u4f1a\u6709\u6027\u80fd\u95ee\u9898\u3002"),(0,n.kt)("h5",{id:"enableidempotencetrue"},"enable.idempotence=true"),(0,n.kt)("p",null,"message ordering <= 5\u65f6\u80fd\u591f\u4fdd\u8bc1\u6d88\u606f\u7684\u987a\u5e8f\u3002"),(0,n.kt)("h5",{id:"quotas"},"Quotas"),(0,n.kt)("h5",{id:"quotaproducerdefault2m"},"quota.producer.default=2M"),(0,n.kt)("p",null,"\u8bbe\u7f6eproducer/consumer/request\u7684 rate limit"),(0,n.kt)("p",null,"\u4f46\u8fd9\u4e2a\u9009\u9879\u53ef\u80fd\u4f1a\u5bfc\u81f4\u6d88\u606f\u56e4\u79ef\u5728producer\u7684\u7f13\u51b2\u533a\uff0c\u5bfc\u81f4\u5b58\u50a8\u6ea2\u51fa"),(0,n.kt)("h3",{id:"reading"},"Reading"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"kdg2 0401",src:l(7789).Z,width:"600",height:"414"})),(0,n.kt)("p",null,"\u5982\u679c\u4e00\u4e2aConsumer group\u91cc\u53ea\u6709\u4e00\u4e2aconsumer\uff0c\u5b83\u4f1a\u63a5\u6536\u5230\u6240\u6709Partition\u7684\u6d88\u606f\u3002"),(0,n.kt)("p",null,"\u5982\u679c\u4e00\u4e2aConsumer group\u91cc\u7684consumer\u6570\u91cf\u5927\u4e8epartition\u6570\u91cf\uff0c\u6709\u7684consumer\u5c31\u63a5\u6536\u4e0d\u5230\u6d88\u606f\u4e86\u3002"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"kdg2 0404",src:l(1641).Z,width:"600",height:"492"})),(0,n.kt)("p",null,"\u5982\u679c\u5b58\u5728\u591a\u4e2aConsumer group\uff0c\u591a\u4e2agroup\u4e4b\u95f4\u662f\u4e92\u76f8\u72ec\u7acb\u7684\u3002"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"kdg2 0405",src:l(6522).Z,width:"600",height:"703"})),(0,n.kt)("h4",{id:"rebalance"},"Rebalance"),(0,n.kt)("p",null,"\u5c06partition\u7684ownership\u4ece\u4e00\u4e2aconsumer\u8f6c\u79fb\u5230\u53e6\u4e00\u4e2aconsumer\uff0c\u79f0\u4e3arebalance."),(0,n.kt)("h5",{id:"eager-rebalance"},"Eager rebalance"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"kdg2 0406",src:l(5750).Z,width:"600",height:"245"})),(0,n.kt)("p",null,"\u6240\u6709consumer\u6682\u505c\u6d88\u8d39\u6d88\u606f\uff0c\u653e\u5f03ownership\uff0c\u91cd\u65b0\u52a0\u5165consumer group\uff0c\u7b49\u5f85broker\u91cd\u65b0\u5206\u914downership\u3002"),(0,n.kt)("h5",{id:"cooperative-rebalanceincremental-rebalance"},"Cooperative rebalance(incremental rebalance)"),(0,n.kt)("p",null,"Consumer group leader\u4f1a\u901a\u77e5\u5176\u4ed6consumer\uff0c\u54ea\u4e9bpartition\u4f1a\u88ab\u91cd\u65b0\u5b89\u6392\u3002own\u8fd9\u4e9bPartiton\u7684consumer\u4f1a\u505c\u6b62\u6d88\u8d39\u8fd9\u4e9bpartition\u7684\u6d88\u606f\uff0c\u7136\u540econsumer group leader\u5c06\u8fd9\u4e9bpartition\u91cd\u65b0\u5206\u914d\u7ed9\u76ee\u6807consumer\u3002"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"kdg2 0407",src:l(1460).Z,width:"600",height:"256"})),(0,n.kt)("p",null,"\u901a\u8fc7\u53d1\u9001\u5fc3\u8df3\u5305\u6765\u786e\u8ba4consumer\u5728\u7ebf\u3002"),(0,n.kt)("p",null,"\u7b2c\u4e00\u4e2a\u52a0\u5165Consumer group\u7684\u6210\u4e3agroup leader\u3002"),(0,n.kt)("h5",{id:"static-group-membership"},"Static group membership"),(0,n.kt)("p",null,"consumer\u4e5f\u53ef\u4ee5\u914d\u7f6e\u4e3a\u9759\u6001\u7684\u6210\u5458\uff0c\u8fd9\u6837\u5f53consumer\u65ad\u5f00\u8fde\u63a5\u540e\uff0c\u5b83\u7684partition\u4e0d\u4f1a\u88abrearrange\uff0c\u800c\u662f\u7b49\u5f85\u5b83\u4e0a\u7ebf\u540e\u6062\u590d\u6d88\u8d39\u3002"),(0,n.kt)("h5",{id:"maxpollintervalms"},"max.poll.interval.ms"),(0,n.kt)("p",null,"\u5c3d\u7ba1kafka\u901a\u8fc7background thread\u5fc3\u8df3\u5305\u6765\u786e\u8ba4consumer\u662f\u5426\u5728\u7ebf\uff0c\u4f46\u662f\u5728\u7ebf\u5e76\u4e0d\u4ee3\u8868\u5b83\u80fd\u591f\u6b63\u5e38\u5904\u7406\u6d88\u606f\u3002"),(0,n.kt)("p",null,"\u53ef\u4ee5\u901a\u8fc7\u8fd9\u4e2a\u503c\u6765\u63a7\u5236\uff0c\u5982\u679cclient\u8d85\u8fc7\u8fd9\u4e2a\u65f6\u95f4\u8fd8\u6ca1\u6709\u53d1\u9001\u7b2c\u4e8c\u6b21poll()\uff0c\u90a3\u4e48\u8ba4\u4e3a\u5b83\u7684\u7ebf\u7a0b\u5df2\u7ecfdead\u4e86\u3002"),(0,n.kt)("p",null,"\u9ed8\u8ba4\u662f5\u5206\u949f"),(0,n.kt)("h5",{id:"autooffsetreset"},"auto.offset.reset"),(0,n.kt)("p",null,"\u6709latest\u548cearliest\u4e24\u79cd\uff0c\u63a7\u5236\u6ca1\u6709offset\u65f6\u662f\u8bfb\u53d6\u6700\u65b0\u6d88\u606f\u8fd8\u662f\u5168\u91cf\u6d88\u606f\u3002"),(0,n.kt)("h5",{id:"partitionassignmentstrategy"},"partition.assignment.strategy"),(0,n.kt)("p",null,(0,n.kt)("em",{parentName:"p"},"Range")),(0,n.kt)("p",null,"partition\u9664\u4ee5consumer count\u540e\uff0c\u5f97\u5230\u8fde\u7eed\u7684\u7f16\u53f7\u8303\u56f4\uff0c\u5206\u914d\u7ed9consumer\u3002"),(0,n.kt)("p",null,(0,n.kt)("em",{parentName:"p"},"RoundRobin")),(0,n.kt)("p",null,"\u628a\u6240\u6709\u7684partition one-by-one\u5206\u914d\u7ed9consumers"),(0,n.kt)("p",null,(0,n.kt)("em",{parentName:"p"},"Sticky")),(0,n.kt)("p",null,"\u6bd4RoundRobin\u66f4\u52a0\u5e73\u8861\uff0c\u5728Reassign\u7684\u65f6\u5019\u51cf\u5c11\u4e86Rebalance\u7684\u6b21\u6570"),(0,n.kt)("p",null,(0,n.kt)("em",{parentName:"p"},"Cooperative Sticky")),(0,n.kt)("p",null,"\u652f\u6301Cooperative Rebalance"),(0,n.kt)("h5",{id:"offsetsretentionminutes"},"offsets.retention.minutes"),(0,n.kt)("p",null,"Group\u91cc\u7684\u6d88\u606f\u88ab\u6d88\u8d39\u5b8c\u4e86\uff0c\u9ed8\u8ba4\u4fdd\u75597\u5929\uff0c\u7136\u540eoffset\u4f1a\u6e05\u96f6\uff0cconsumer group\u4f1a\u548c\u65b0\u52a0\u5165\u7684\u4e00\u6837\u3002"),(0,n.kt)("h4",{id:"offsets"},"Offsets"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"kdg2 0408",src:l(6768).Z,width:"600",height:"257"})),(0,n.kt)("p",null,"\u5982\u4e0a\u56fe\uff0c\u6700\u574f\u7684\u60c5\u51b5\uff1a\u5982\u679cBatchSize=5\uff0c\u4e0a\u4e00\u4e2aBatch\u5904\u7406\u5b8c\u4e86\uff0c\u6536\u5230\u4e0b\u4e00\u4e2aBatch\u3002\u4f46\u662fCommit Offset=7\u6ca1\u6709\u53d1\u51fa\u53bb\uff0c\u7136\u540e\u5904\u7406\u523010\u7684\u65f6\u5019consumer\u6302\u4e86\u3002\u8fd9\u4e2a\u65f6\u5019\uff0c\u4e0b\u4e00\u4e2a\u63a5\u66ff\u7684consumer\u4f1a\u4ece2\u5f00\u59cb\u5904\u7406\uff0c\u5bfc\u81f4\u4ece3~10\u8fd9\u51e0\u4e2a\u90fd\u88ab\u91cd\u590d\u5904\u7406\u4e86\u3002"),(0,n.kt)("p",null,"\u89e3\u51b3\u529e\u6cd5\u5c31\u662fmanual commit offset\uff0c\u8c03\u7528API\u5904\u7406\u5b8c\u4e00\u6761\u6d88\u606f\u540e\u5c31commit\u3002"),(0,n.kt)("p",null,"commitAsync\u6ca1\u6709retry\uff0ccommitSync\u6709retry\u3002"),(0,n.kt)("p",null,"\u5f53\u7136\uff0c\u589e\u52a0Specified commit\u4f1a\u51cf\u5c11\u51fa\u9519\u65f6\u91cd\u590d\u5904\u7406\u7684\u6d88\u606f\u6570\u91cf\uff0c\u4f46\u4e5f\u4f1a\u964d\u4f4eThroughput\u3002"),(0,n.kt)("h4",{id:"atomic-multipartition-writes"},"atomic multipartition writes"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"kdg2 0801",src:l(3056).Z,width:"600",height:"235"})),(0,n.kt)("p",null,"Consume\uff0cProcess\uff0cProduce\u4e09\u6b65\u5f62\u6210\u4e00\u4e2a\u539f\u5b50\u64cd\u4f5c\uff0c\u5c31\u662f\u8ba9Produce\u65f6\u540c\u65f6\u66f4\u65b0\u6570\u636e\u548cOffset\uff0c\u8981\u4e48\u90fd\u65e0\u6cd5\u66f4\u65b0\u8981\u4e48\u90fd\u53ef\u4ee5\u66f4\u65b0\u3002"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"kdg2 0802",src:l(9273).Z,width:"600",height:"315"})),(0,n.kt)("p",null,"Last Stable Offset, or LSO"),(0,n.kt)("h3",{id:"\u5b89\u88c5"},"\u5b89\u88c5"),(0,n.kt)("h4",{id:"mac"},"Mac"),(0,n.kt)("p",null,"\u5b89\u88c5openjdk"),(0,n.kt)("p",null,(0,n.kt)("inlineCode",{parentName:"p"},"brew install openjdk")),(0,n.kt)("p",null,"\u7136\u540e\u5f00\u542fzookeeper"),(0,n.kt)("p",null,(0,n.kt)("inlineCode",{parentName:"p"},"zookeeper-server-start /opt/homebrew/Cellar/kafka/3.2.0/libexec/config/zookeeper.properties")),(0,n.kt)("p",null,"\u5f00\u542fkafka"),(0,n.kt)("p",null,"Enable JMX"),(0,n.kt)("p",null,(0,n.kt)("a",{parentName:"p",href:"https://docs.microfocus.com/doc/MP_for_Apache_Kafka/1.10/Kafka/Kafka_JMX"},"ITOM Practitioner Portal (microfocus.com)")),(0,n.kt)("p",null,(0,n.kt)("inlineCode",{parentName:"p"},"env JMX_PORT=<portnumber> kafka-server-start /opt/homebrew/Cellar/kafka/3.2.0/libexec/config/server.properties")),(0,n.kt)("p",null,"\u521b\u5efatopic"),(0,n.kt)("p",null,(0,n.kt)("inlineCode",{parentName:"p"},"kafka-topics --bootstrap-server localhost:9092 --create --replication-factor 1 --partitions 1 --topic test")),(0,n.kt)("p",null,"\u8f93\u51fa\uff1a\nCreated topic test."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"(base) \u279c  ~ kafka-topics --bootstrap-server localhost:9092 --describe --topic test\nTopic: test TopicId: cqJ9A01WRpOhwcD1sBLKTA PartitionCount: 1   ReplicationFactor: 1    Configs: segment.bytes=1073741824\n    Topic: test Partition: 0    Leader: 0   Replicas: 0 Isr: 0\n(base) \u279c  ~\n")),(0,n.kt)("p",null,"\u6d4b\u8bd5Consumer \u548c Producer"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"(base) \u279c  ~ kafka-console-producer --bootstrap-server localhost:9092 --topic test\n>Hello Kafka\n>Bye\n>^C%\n(base) \u279c  ~ kafka-console-consumer --bootstrap-server localhost:9092 --topic test\n^CProcessed a total of 0 messages\n(base) \u279c  ~ kafka-console-consumer --bootstrap-server localhost:9092 --topic test --from-beginning\nHello Kafka\nBye\n^CProcessed a total of 2 messages\n(base) \u279c  ~ kafka-console-consumer --bootstrap-server localhost:9092 --topic test --from-beginning\nHello Kafka\nBye\n^CProcessed a total of 2 messages\n(base) \u279c  ~\n")),(0,n.kt)("p",null,"\u8fd9\u91cc\u53ef\u4ee5\u7528zkcli\u770b\u5230\uff0ckafka\u5df2\u7ecf\u5728\u66f4\u65b0zookeeper\u7684\u72b6\u6001\uff1a"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"[zk: localhost:2181(CONNECTED) 2] ls /\n[admin, brokers, cluster, config, consumers, controller, controller_epoch, feature, isr_change_notification, latest_producer_id_block, log_dir_event_notification, zookeeper]\n[zk: localhost:2181(CONNECTED) 3] ls /brokers\n[ids, seqid, topics]\n[zk: localhost:2181(CONNECTED) 4] ls /brokers/topics\n[__consumer_offsets, test]\n[zk: localhost:2181(CONNECTED) 5] ls /brokers/topics/test\n[partitions]\n[zk: localhost:2181(CONNECTED) 6] ls /brokers/topics/test/partitions\n[0]\n[zk: localhost:2181(CONNECTED) 7] ls /brokers/topics/test/partitions/0\n[state]\n[zk: localhost:2181(CONNECTED) 8] ls /brokers/topics/test/partitions/0/state\n[]\n[zk: localhost:2181(CONNECTED) 9] ls /brokers/topics/__consumer_offsets\n[partitions]\n[zk: localhost:2181(CONNECTED) 10] ls /brokers/topics/__consumer_offsets/partitions\n[0, 1, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 2, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 3, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 4, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 5, 6, 7, 8, 9]\n")),(0,n.kt)("p",null,"\u6211\u4eec\u53ef\u4ee5\u7528cmak\u5de5\u5177\u6765\u770b\uff1a"),(0,n.kt)("p",null,(0,n.kt)("a",{parentName:"p",href:"https://github.com/yahoo/CMAK"},"https://github.com/yahoo/CMAK")),(0,n.kt)("p",null,"\u4e0b\u8f7d\u4e0b\u6765\u540e\uff0c\u4fee\u6539application.conf\u6587\u4ef6"),(0,n.kt)("p",null,(0,n.kt)("inlineCode",{parentName:"p"},'cmak.zkhosts="0.0.0.0:2181"')),(0,n.kt)("p",null,"\u7136\u540e\u542f\u52a8\uff0c\u6ce8\u610f\u4e0d\u8981\u7528jdk16\u4ee5\u4e0a\u7684\u7248\u672c\uff0c\u52a0\u8f7dcss\u4f1a\u62a5\u9519\uff0c\u5e94\u8be5\u662f\u4e2abug"),(0,n.kt)("p",null,(0,n.kt)("inlineCode",{parentName:"p"},"bin/cmak -java-home /opt/homebrew/opt/openjdk@11/")),(0,n.kt)("p",null,"\u7136\u540e\u8bbf\u95eelocalhost:9000"),(0,n.kt)("p",null,"\u6dfb\u52a0cluster, zk \u8bbe\u7f6e\u4e3alocalhost:9000"),(0,n.kt)("p",null,"\u53ef\u4ee5\u770b\u5230topics\uff0cbrokers"),(0,n.kt)("p",null,"\u70b9\u8fdbtopics"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"image-20220821104616084",src:l(1304).Z,width:"2538",height:"1318"})),(0,n.kt)("p",null,"\u5982\u679cenable\u4e86JMX\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u770b\u5230metrics\u4e86\u3002"),(0,n.kt)("p",null,"\u6bd4\u5982\u8d77\u4e00\u4e2aconsole,\u4f5c\u4e3aconsumer\uff0c\u4e00\u4e2a\u4f5c\u4e3aproducer"),(0,n.kt)("p",null,(0,n.kt)("inlineCode",{parentName:"p"},"\u279c  ~ kafka-console-consumer --bootstrap-server localhost:9092 --topic test")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"~ kafka-console-producer --bootstrap-server localhost:9092 --topic test\n>hello\n>i'm fine\n")),(0,n.kt)("p",null,"\u53d1\u73b0consumer\u90a3\u8fb9\u6536\u5230\u4e86\u6d88\u606f\uff1a"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"\u279c  ~ kafka-console-consumer --bootstrap-server localhost:9092 --topic test\nhello\ni'm fine\n\n")),(0,n.kt)("p",null,"\u7136\u540e\u56de\u5230CMAK\uff0c\u5237\u65b0\uff0c\u53d1\u73b0metrics\u6709\u53d8\u5316"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"image-20220821110425179",src:l(6897).Z,width:"974",height:"828"})))}d.isMDXComponent=!0},4217:function(e,t,l){t.Z=l.p+"assets/images/7f217c5bf9bd4787619b7b4861ca6bda-8234c48a15ca24bfbd7a7ad0edf5124f.png"},5813:function(e,t,l){t.Z=l.p+"assets/images/beb09748d5824fa025c5eb30146ffa34-6c73d346e16ef2546d86d4a278b47a50.png"},1304:function(e,t,l){t.Z=l.p+"assets/images/image-20220821104616084-2bafbc84af13313c17433cf7c5548d93.png"},6897:function(e,t,l){t.Z=l.p+"assets/images/image-20220821110425179-a06ac1f9c1ff900af8d8bfe54ea0af34.png"},5965:function(e,t,l){t.Z=l.p+"assets/images/kdg2_0102-3ff1d183894dec028ba940ac5c22c527.png"},4171:function(e,t,l){t.Z=l.p+"assets/images/kdg2_0103-d273072b356aca9371f513a329584120.png"},5133:function(e,t,l){t.Z=l.p+"assets/images/kdg2_0105-f0095512f3a6e6e3d6319de7731a6f27.png"},2725:function(e,t,l){t.Z=l.p+"assets/images/kdg2_0106-83073a5adf405a3bbffdc36ef66cfb92.png"},4592:function(e,t,l){t.Z=l.p+"assets/images/kdg2_0107-b4ebe8f1030867ba5db2a5ee89de5fdc.png"},5237:function(e,t,l){t.Z=l.p+"assets/images/kdg2_0108-6511d0382ca6da80e989d49e18c6ef1e.png"},6455:function(e,t,l){t.Z=l.p+"assets/images/kdg2_0109-4b5a0ebf4c022d05751181192c3b5a7e.png"},5908:function(e,t,l){t.Z=l.p+"assets/images/kdg2_0301-6270ff81e68f0b68296c40adfdf6a474.png"},1963:function(e,t,l){t.Z=l.p+"assets/images/kdg2_0302-b1d904a8bb642c9846a15487f3be3846.png"},7789:function(e,t,l){t.Z=l.p+"assets/images/kdg2_0401-3458f79a2c9dde22318fcb1b5872c771.png"},1641:function(e,t,l){t.Z=l.p+"assets/images/kdg2_0404-982fdc03ee2e6e5fc4020627e3c42e42.png"},6522:function(e,t,l){t.Z=l.p+"assets/images/kdg2_0405-d98482b89964f525a4efeac88e165bd5.png"},5750:function(e,t,l){t.Z=l.p+"assets/images/kdg2_0406-d33991e55a8e7587cc1743c9e2fd3a67.png"},1460:function(e,t,l){t.Z=l.p+"assets/images/kdg2_0407-ce045ddddf0153f0facd06a70dc6f53f.png"},6768:function(e,t,l){t.Z=l.p+"assets/images/kdg2_0408-2fc3ff5c547d978a086f2f994cee04cc.png"},4827:function(e,t,l){t.Z=l.p+"assets/images/kdg2_0602-3351456e97e886ce96f0102eea845e08.png"},9626:function(e,t,l){t.Z=l.p+"assets/images/kdg2_0605-4b007b734117460cbe0e4547deb036c6.png"},8541:function(e,t,l){t.Z=l.p+"assets/images/kdg2_0607-06a8f0f701e39e7fe377017b54c965d9.png"},3056:function(e,t,l){t.Z=l.p+"assets/images/kdg2_0801-cfdde2cce5f37db927f4712a4f3c05ad.png"},9273:function(e,t,l){t.Z=l.p+"assets/images/kdg2_0802-10207f5fc204b9d2f008c62a420cfb41.png"},1079:function(e,t,l){t.Z=l.p+"assets/images/zook_0201-f348c18600f23040fc76ea4ecbd16b0b.png"},55:function(e,t,l){t.Z=l.p+"assets/images/zook_0202-13e643b8ad36e9e732adb6d0f56baccb.png"},8670:function(e,t,l){t.Z=l.p+"assets/images/zook_0203-b68ec627cd5555c1daa34ec82c658ffc.png"},2865:function(e,t,l){t.Z=l.p+"assets/images/zook_0204-ca2ed752621e26578f07df89dfb7addb.png"},386:function(e,t,l){t.Z=l.p+"assets/images/zook_0205-8ffc44a8ecad7e5122d3e4779a25b3e4.png"},9703:function(e,t,l){t.Z=l.p+"assets/images/zook_0901-0b72139b0918b4fd1bda227adde8f74b.png"},7849:function(e,t,l){t.Z=l.p+"assets/images/zook_0902-6d04d36e7bd7de5efc353b8b4114cd66.png"},4316:function(e,t,l){t.Z=l.p+"assets/images/zook_0904-4ffadd2e45da58b58d5f305a2fd774de.png"},3451:function(e,t,l){t.Z=l.p+"assets/images/zook_0907-3fbb513b423536af2d921cd060835337.png"}}]);